{"version":3,"file":"EBMLEncoder.js","sources":["../../../../../node_modules/webm-duration-fix/lib/ebml/EBMLEncoder.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tools = require(\"./tools\");\nvar tools_1 = require(\"./tools\");\nvar ebmlID_1 = require(\"./ebmlID\");\nvar EBMLEncoder = /** @class */ (function () {\n    function EBMLEncoder() {\n        this._schema = ebmlID_1.byEbmlID;\n        this._buffers = [];\n        this._stack = [];\n    }\n    EBMLEncoder.prototype.encode = function (elms) {\n        var _this = this;\n        return tools.concat(elms.reduce(function (lst, elm) {\n            return lst.concat(_this.encodeChunk(elm));\n        }, [])).buffer;\n    };\n    EBMLEncoder.prototype.encodeChunk = function (elm) {\n        if (elm.type === \"m\") {\n            if (!elm.isEnd) {\n                this.startTag(elm);\n            }\n            else {\n                this.endTag(elm);\n            }\n        }\n        else {\n            // ensure that we are working with an internal `Buffer` instance\n            elm.data = tools_1.Buffer.from(elm.data);\n            this.writeTag(elm);\n        }\n        return this.flush();\n    };\n    EBMLEncoder.prototype.flush = function () {\n        var ret = this._buffers;\n        this._buffers = [];\n        return ret;\n    };\n    EBMLEncoder.prototype.getSchemaInfo = function (tagName) {\n        var tagNums = Object.keys(this._schema).map(Number);\n        for (var i = 0; i < tagNums.length; i++) {\n            var tagNum = tagNums[i];\n            if (this._schema[tagNum].name === tagName) {\n                return new tools_1.Buffer(tagNum.toString(16), 'hex');\n            }\n        }\n        return null;\n    };\n    EBMLEncoder.prototype.writeTag = function (elm) {\n        var tagName = elm.name;\n        var tagId = this.getSchemaInfo(tagName);\n        var tagData = elm.data;\n        if (tagId == null) {\n            throw new Error('No schema entry found for ' + tagName);\n        }\n        var data = tools.encodeTag(tagId, tagData);\n        /**\n         * 親要素が閉じタグあり(isEnd)なら閉じタグが来るまで待つ(children queに入る)\n         */\n        if (this._stack.length > 0) {\n            var last = this._stack[this._stack.length - 1];\n            last.children.push({\n                tagId: tagId,\n                elm: elm,\n                children: [],\n                data: data\n            });\n            return;\n        }\n        this._buffers = this._buffers.concat(data);\n        return;\n    };\n    EBMLEncoder.prototype.startTag = function (elm) {\n        var tagName = elm.name;\n        var tagId = this.getSchemaInfo(tagName);\n        if (tagId == null) {\n            throw new Error('No schema entry found for ' + tagName);\n        }\n        /**\n         * 閉じタグ不定長の場合はスタックに積まずに即時バッファに書き込む\n         */\n        if (elm.unknownSize) {\n            var data = tools.encodeTag(tagId, new tools_1.Buffer(0), elm.unknownSize);\n            this._buffers = this._buffers.concat(data);\n            return;\n        }\n        var tag = {\n            tagId: tagId,\n            elm: elm,\n            children: [],\n            data: null\n        };\n        if (this._stack.length > 0) {\n            this._stack[this._stack.length - 1].children.push(tag);\n        }\n        this._stack.push(tag);\n    };\n    EBMLEncoder.prototype.endTag = function (elm) {\n        var tagName = elm.name;\n        var tag = this._stack.pop();\n        if (tag == null) {\n            throw new Error(\"EBML structure is broken\");\n        }\n        if (tag.elm.name !== elm.name) {\n            throw new Error(\"EBML structure is broken\");\n        }\n        var childTagDataBuffers = tag.children.reduce(function (lst, child) {\n            if (child.data === null) {\n                throw new Error(\"EBML structure is broken\");\n            }\n            return lst.concat(child.data);\n        }, []);\n        var childTagDataBuffer = tools.concat(childTagDataBuffers);\n        if (tag.elm.type === \"m\") {\n            tag.data = tools.encodeTag(tag.tagId, childTagDataBuffer, tag.elm.unknownSize);\n        }\n        else {\n            tag.data = tools.encodeTag(tag.tagId, childTagDataBuffer);\n        }\n        if (this._stack.length < 1) {\n            this._buffers = this._buffers.concat(tag.data);\n        }\n    };\n    return EBMLEncoder;\n}());\nexports.default = EBMLEncoder;\n"],"names":["Object","defineProperty","EBMLEncoder_1","__exports","value","tools","require$$0","tools_1","ebmlID_1","require$$1","EBMLEncoder","this","_schema","byEbmlID","_buffers","_stack","prototype","encode","elms","_this","concat","reduce","lst","elm","encodeChunk","buffer","type","isEnd","endTag","startTag","data","Buffer","from","writeTag","flush","ret","getSchemaInfo","tagName","tagNums","keys","map","Number","i","length","tagNum","name","toString","tagId","tagData","Error","encodeTag","children","push","unknownSize","tag","pop","childTagDataBuffers","child","childTagDataBuffer","default"],"mappings":"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"}