"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../motion/features/definitions.mjs.js"),e=require("../projection/geometry/models.mjs.js"),s=require("../utils/reduced-motion/index.mjs.js"),i=require("../utils/reduced-motion/state.mjs.js"),r=require("../value/utils/is-motion-value.mjs.js"),o=require("./store.mjs.js"),n=require("./utils/is-controlling-variants.mjs.js"),a=require("./utils/motion-values.mjs.js"),u=require("./utils/resolve-variants.mjs.js"),h=require("../../../../motion-dom/dist/es/animation/keyframes/KeyframesResolver.mjs.js"),l=require("../../../../motion-dom/dist/es/frameloop/sync-time.mjs.js"),d=require("../../../../motion-dom/dist/es/frameloop/frame.mjs.js"),p=require("../../../../motion-utils/dist/es/warn-once.mjs.js"),c=require("../../../../motion-dom/dist/es/render/utils/keys-transform.mjs.js"),m=require("../../../../motion-dom/dist/es/value/index.mjs.js"),v=require("../../../../motion-utils/dist/es/is-numerical-string.mjs.js"),V=require("../../../../motion-utils/dist/es/is-zero-value-string.mjs.js"),f=require("../../../../motion-dom/dist/es/value/types/utils/find.mjs.js"),g=require("../../../../motion-dom/dist/es/value/types/complex/index.mjs.js"),j=require("../../../../motion-dom/dist/es/value/types/utils/animatable-none.mjs.js"),M=require("../../../../motion-utils/dist/es/subscription-manager.mjs.js");const y=["AnimationStart","AnimationComplete","Update","BeforeLayoutMeasure","LayoutMeasure","LayoutAnimationStart","LayoutAnimationComplete"];exports.VisualElement=class{scrapeMotionValuesFromProps(t,e,s){return{}}constructor({parent:t,props:e,presenceContext:s,reducedMotionConfig:i,blockInitialAnimation:o,visualState:a},u={}){this.current=null,this.children=new Set,this.isVariantNode=!1,this.isControllingVariants=!1,this.shouldReduceMotion=null,this.values=new Map,this.KeyframeResolver=h.KeyframeResolver,this.features={},this.valueSubscriptions=new Map,this.prevMotionValues={},this.events={},this.propEventSubscriptions={},this.notifyUpdate=()=>this.notify("Update",this.latestValues),this.render=()=>{this.current&&(this.triggerBuild(),this.renderInstance(this.current,this.renderState,this.props.style,this.projection))},this.renderScheduledAt=0,this.scheduleRender=()=>{const t=l.time.now();this.renderScheduledAt<t&&(this.renderScheduledAt=t,d.frame.render(this.render,!1,!0))};const{latestValues:p,renderState:c}=a;this.latestValues=p,this.baseTarget={...p},this.initialValues=e.initial?{...p}:{},this.renderState=c,this.parent=t,this.props=e,this.presenceContext=s,this.depth=t?t.depth+1:0,this.reducedMotionConfig=i,this.options=u,this.blockInitialAnimation=Boolean(o),this.isControllingVariants=n.isControllingVariants(e),this.isVariantNode=n.isVariantNode(e),this.isVariantNode&&(this.variantChildren=new Set),this.manuallyAnimateOnMount=Boolean(t&&t.current);const{willChange:m,...v}=this.scrapeMotionValuesFromProps(e,{},this);for(const t in v){const e=v[t];void 0!==p[t]&&r.isMotionValue(e)&&e.set(p[t],!1)}}mount(t){this.current=t,o.visualElementStore.set(t,this),this.projection&&!this.projection.instance&&this.projection.mount(t),this.parent&&this.isVariantNode&&!this.isControllingVariants&&(this.removeFromVariantTree=this.parent.addVariantChild(this)),this.values.forEach(((t,e)=>this.bindToMotionValue(e,t))),i.hasReducedMotionListener.current||s.initPrefersReducedMotion(),this.shouldReduceMotion="never"!==this.reducedMotionConfig&&("always"===this.reducedMotionConfig||i.prefersReducedMotion.current),"production"!==process.env.NODE_ENV&&p.warnOnce(!0!==this.shouldReduceMotion,"You have Reduced Motion enabled on your device. Animations may not appear as expected."),this.parent&&this.parent.children.add(this),this.update(this.props,this.presenceContext)}unmount(){this.projection&&this.projection.unmount(),d.cancelFrame(this.notifyUpdate),d.cancelFrame(this.render),this.valueSubscriptions.forEach((t=>t())),this.valueSubscriptions.clear(),this.removeFromVariantTree&&this.removeFromVariantTree(),this.parent&&this.parent.children.delete(this);for(const t in this.events)this.events[t].clear();for(const t in this.features){const e=this.features[t];e&&(e.unmount(),e.isMounted=!1)}this.current=null}bindToMotionValue(t,e){this.valueSubscriptions.has(t)&&this.valueSubscriptions.get(t)();const s=c.transformProps.has(t);s&&this.onBindTransform&&this.onBindTransform();const i=e.on("change",(e=>{this.latestValues[t]=e,this.props.onUpdate&&d.frame.preRender(this.notifyUpdate),s&&this.projection&&(this.projection.isTransformDirty=!0)})),r=e.on("renderRequest",this.scheduleRender);let o;window.MotionCheckAppearSync&&(o=window.MotionCheckAppearSync(this,t,e)),this.valueSubscriptions.set(t,(()=>{i(),r(),o&&o(),e.owner&&e.stop()}))}sortNodePosition(t){return this.current&&this.sortInstanceNodePosition&&this.type===t.type?this.sortInstanceNodePosition(this.current,t.current):0}updateFeatures(){let e="animation";for(e in t.featureDefinitions){const s=t.featureDefinitions[e];if(!s)continue;const{isEnabled:i,Feature:r}=s;if(!this.features[e]&&r&&i(this.props)&&(this.features[e]=new r(this)),this.features[e]){const t=this.features[e];t.isMounted?t.update():(t.mount(),t.isMounted=!0)}}}triggerBuild(){this.build(this.renderState,this.latestValues,this.props)}measureViewportBox(){return this.current?this.measureInstanceViewportBox(this.current,this.props):e.createBox()}getStaticValue(t){return this.latestValues[t]}setStaticValue(t,e){this.latestValues[t]=e}update(t,e){(t.transformTemplate||this.props.transformTemplate)&&this.scheduleRender(),this.prevProps=this.props,this.props=t,this.prevPresenceContext=this.presenceContext,this.presenceContext=e;for(let e=0;e<y.length;e++){const s=y[e];this.propEventSubscriptions[s]&&(this.propEventSubscriptions[s](),delete this.propEventSubscriptions[s]);const i=t["on"+s];i&&(this.propEventSubscriptions[s]=this.on(s,i))}this.prevMotionValues=a.updateMotionValuesFromProps(this,this.scrapeMotionValuesFromProps(t,this.prevProps,this),this.prevMotionValues),this.handleChildMotionValue&&this.handleChildMotionValue()}getProps(){return this.props}getVariant(t){return this.props.variants?this.props.variants[t]:void 0}getDefaultTransition(){return this.props.transition}getTransformPagePoint(){return this.props.transformPagePoint}getClosestVariantNode(){return this.isVariantNode?this:this.parent?this.parent.getClosestVariantNode():void 0}addVariantChild(t){const e=this.getClosestVariantNode();if(e)return e.variantChildren&&e.variantChildren.add(t),()=>e.variantChildren.delete(t)}addValue(t,e){const s=this.values.get(t);e!==s&&(s&&this.removeValue(t),this.bindToMotionValue(t,e),this.values.set(t,e),this.latestValues[t]=e.get())}removeValue(t){this.values.delete(t);const e=this.valueSubscriptions.get(t);e&&(e(),this.valueSubscriptions.delete(t)),delete this.latestValues[t],this.removeValueFromRenderState(t,this.renderState)}hasValue(t){return this.values.has(t)}getValue(t,e){if(this.props.values&&this.props.values[t])return this.props.values[t];let s=this.values.get(t);return void 0===s&&void 0!==e&&(s=m.motionValue(null===e?void 0:e,{owner:this}),this.addValue(t,s)),s}readValue(t,e){let s=void 0===this.latestValues[t]&&this.current?this.getBaseTargetFromProps(this.props,t)??this.readValueFromInstance(this.current,t,this.options):this.latestValues[t];return null!=s&&("string"==typeof s&&(v.isNumericalString(s)||V.isZeroValueString(s))?s=parseFloat(s):!f.findValueType(s)&&g.complex.test(e)&&(s=j.getAnimatableNone(t,e)),this.setBaseTarget(t,r.isMotionValue(s)?s.get():s)),r.isMotionValue(s)?s.get():s}setBaseTarget(t,e){this.baseTarget[t]=e}getBaseTarget(t){const{initial:e}=this.props;let s;if("string"==typeof e||"object"==typeof e){const i=u.resolveVariantFromProps(this.props,e,this.presenceContext?.custom);i&&(s=i[t])}if(e&&void 0!==s)return s;const i=this.getBaseTargetFromProps(this.props,t);return void 0===i||r.isMotionValue(i)?void 0!==this.initialValues[t]&&void 0===s?void 0:this.baseTarget[t]:i}on(t,e){return this.events[t]||(this.events[t]=new M.SubscriptionManager),this.events[t].add(e)}notify(t,...e){this.events[t]&&this.events[t].notify(...e)}};
//# sourceMappingURL=VisualElement.mjs.js.map
