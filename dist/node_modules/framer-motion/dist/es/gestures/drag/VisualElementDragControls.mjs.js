"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../../animation/interfaces/motion-value.mjs.js"),s=require("../../events/add-dom-event.mjs.js"),i=require("../../events/add-pointer-event.mjs.js"),e=require("../../events/event-info.mjs.js"),n=require("../../projection/geometry/conversion.mjs.js"),o=require("../../projection/geometry/delta-calc.mjs.js"),r=require("../../projection/geometry/models.mjs.js"),a=require("../../projection/utils/each-axis.mjs.js"),l=require("../../projection/utils/measure.mjs.js"),c=require("../../utils/get-context-window.mjs.js"),u=require("../../utils/is-ref-object.mjs.js"),h=require("../../value/use-will-change/add-will-change.mjs.js"),g=require("../pan/PanSession.mjs.js"),m=require("./utils/constraints.mjs.js"),d=require("../../../../../motion-dom/dist/es/frameloop/frame.mjs.js"),p=require("../../../../../motion-utils/dist/es/errors.mjs.js"),v=require("../../../../../motion-dom/dist/es/gestures/drag/state/set-active.mjs.js"),j=require("../../../../../motion-dom/dist/es/value/types/numbers/units.mjs.js"),x=require("../../../../../motion-dom/dist/es/utils/mix/number.mjs.js");const f=new WeakMap;function E(t,s,i){return!(!0!==s&&s!==t||null!==i&&i!==t)}exports.VisualElementDragControls=class{constructor(t){this.openDragLock=null,this.isDragging=!1,this.currentDirection=null,this.originPoint={x:0,y:0},this.constraints=!1,this.hasMutatedConstraints=!1,this.elastic=r.createBox(),this.visualElement=t}start(t,{snapToCursor:s=!1}={}){const{presenceContext:i}=this.visualElement;if(i&&!1===i.isPresent)return;const{dragSnapToOrigin:n}=this.getProps();this.panSession=new g.PanSession(t,{onSessionStart:t=>{const{dragSnapToOrigin:i}=this.getProps();i?this.pauseAnimation():this.stopAnimation(),s&&this.snapToCursor(e.extractEventInfo(t).point)},onStart:(t,s)=>{const{drag:i,dragPropagation:e,onDragStart:n}=this.getProps();if(i&&!e&&(this.openDragLock&&this.openDragLock(),this.openDragLock=v.setDragLock(i),!this.openDragLock))return;this.isDragging=!0,this.currentDirection=null,this.resolveConstraints(),this.visualElement.projection&&(this.visualElement.projection.isAnimationBlocked=!0,this.visualElement.projection.target=void 0),a.eachAxis((t=>{let s=this.getAxisMotionValue(t).get()||0;if(j.percent.test(s)){const{projection:i}=this.visualElement;if(i&&i.layout){const e=i.layout.layoutBox[t];if(e){s=o.calcLength(e)*(parseFloat(s)/100)}}}this.originPoint[t]=s})),n&&d.frame.postRender((()=>n(t,s))),h.addValueToWillChange(this.visualElement,"transform");const{animationState:r}=this.visualElement;r&&r.setActive("whileDrag",!0)},onMove:(t,s)=>{const{dragPropagation:i,dragDirectionLock:e,onDirectionLock:n,onDrag:o}=this.getProps();if(!i&&!this.openDragLock)return;const{offset:r}=s;if(e&&null===this.currentDirection)return this.currentDirection=function(t,s=10){let i=null;Math.abs(t.y)>s?i="y":Math.abs(t.x)>s&&(i="x");return i}(r),void(null!==this.currentDirection&&n&&n(this.currentDirection));this.updateAxis("x",s.point,r),this.updateAxis("y",s.point,r),this.visualElement.render(),o&&o(t,s)},onSessionEnd:(t,s)=>this.stop(t,s),resumeAnimation:()=>a.eachAxis((t=>"paused"===this.getAnimationState(t)&&this.getAxisMotionValue(t).animation?.play()))},{transformPagePoint:this.visualElement.getTransformPagePoint(),dragSnapToOrigin:n,contextWindow:c.getContextWindow(this.visualElement)})}stop(t,s){const i=this.isDragging;if(this.cancel(),!i)return;const{velocity:e}=s;this.startAnimation(e);const{onDragEnd:n}=this.getProps();n&&d.frame.postRender((()=>n(t,s)))}cancel(){this.isDragging=!1;const{projection:t,animationState:s}=this.visualElement;t&&(t.isAnimationBlocked=!1),this.panSession&&this.panSession.end(),this.panSession=void 0;const{dragPropagation:i}=this.getProps();!i&&this.openDragLock&&(this.openDragLock(),this.openDragLock=null),s&&s.setActive("whileDrag",!1)}updateAxis(t,s,i){const{drag:e}=this.getProps();if(!i||!E(t,e,this.currentDirection))return;const n=this.getAxisMotionValue(t);let o=this.originPoint[t]+i[t];this.constraints&&this.constraints[t]&&(o=m.applyConstraints(o,this.constraints[t],this.elastic[t])),n.set(o)}resolveConstraints(){const{dragConstraints:t,dragElastic:s}=this.getProps(),i=this.visualElement.projection&&!this.visualElement.projection.layout?this.visualElement.projection.measure(!1):this.visualElement.projection?.layout,e=this.constraints;t&&u.isRefObject(t)?this.constraints||(this.constraints=this.resolveRefConstraints()):this.constraints=!(!t||!i)&&m.calcRelativeConstraints(i.layoutBox,t),this.elastic=m.resolveDragElastic(s),e!==this.constraints&&i&&this.constraints&&!this.hasMutatedConstraints&&a.eachAxis((t=>{!1!==this.constraints&&this.getAxisMotionValue(t)&&(this.constraints[t]=m.rebaseAxisConstraints(i.layoutBox[t],this.constraints[t]))}))}resolveRefConstraints(){const{dragConstraints:t,onMeasureDragConstraints:s}=this.getProps();if(!t||!u.isRefObject(t))return!1;const i=t.current;p.invariant(null!==i,"If `dragConstraints` is set as a React ref, that ref must be passed to another component's `ref` prop.");const{projection:e}=this.visualElement;if(!e||!e.layout)return!1;const o=l.measurePageBox(i,e.root,this.visualElement.getTransformPagePoint());let r=m.calcViewportConstraints(e.layout.layoutBox,o);if(s){const t=s(n.convertBoxToBoundingBox(r));this.hasMutatedConstraints=!!t,t&&(r=n.convertBoundingBoxToBox(t))}return r}startAnimation(t){const{drag:s,dragMomentum:i,dragElastic:e,dragTransition:n,dragSnapToOrigin:o,onDragTransitionEnd:r}=this.getProps(),l=this.constraints||{},c=a.eachAxis((r=>{if(!E(r,s,this.currentDirection))return;let a=l&&l[r]||{};o&&(a={min:0,max:0});const c=e?200:1e6,u=e?40:1e7,h={type:"inertia",velocity:i?t[r]:0,bounceStiffness:c,bounceDamping:u,timeConstant:750,restDelta:1,restSpeed:10,...n,...a};return this.startAxisValueAnimation(r,h)}));return Promise.all(c).then(r)}startAxisValueAnimation(s,i){const e=this.getAxisMotionValue(s);return h.addValueToWillChange(this.visualElement,s),e.start(t.animateMotionValue(s,e,0,i,this.visualElement,!1))}stopAnimation(){a.eachAxis((t=>this.getAxisMotionValue(t).stop()))}pauseAnimation(){a.eachAxis((t=>this.getAxisMotionValue(t).animation?.pause()))}getAnimationState(t){return this.getAxisMotionValue(t).animation?.state}getAxisMotionValue(t){const s=`_drag${t.toUpperCase()}`,i=this.visualElement.getProps(),e=i[s];return e||this.visualElement.getValue(t,(i.initial?i.initial[t]:void 0)||0)}snapToCursor(t){a.eachAxis((s=>{const{drag:i}=this.getProps();if(!E(s,i,this.currentDirection))return;const{projection:e}=this.visualElement,n=this.getAxisMotionValue(s);if(e&&e.layout){const{min:i,max:o}=e.layout.layoutBox[s];n.set(t[s]-x.mixNumber(i,o,.5))}}))}scalePositionWithinConstraints(){if(!this.visualElement.current)return;const{drag:t,dragConstraints:s}=this.getProps(),{projection:i}=this.visualElement;if(!u.isRefObject(s)||!i||!this.constraints)return;this.stopAnimation();const e={x:0,y:0};a.eachAxis((t=>{const s=this.getAxisMotionValue(t);if(s&&!1!==this.constraints){const i=s.get();e[t]=m.calcOrigin({min:i,max:i},this.constraints[t])}}));const{transformTemplate:n}=this.visualElement.getProps();this.visualElement.current.style.transform=n?n({},""):"none",i.root&&i.root.updateScroll(),i.updateLayout(),this.resolveConstraints(),a.eachAxis((s=>{if(!E(s,t,null))return;const i=this.getAxisMotionValue(s),{min:n,max:o}=this.constraints[s];i.set(x.mixNumber(n,o,e[s]))}))}addListeners(){if(!this.visualElement.current)return;f.set(this.visualElement,this);const t=this.visualElement.current,e=i.addPointerEvent(t,"pointerdown",(t=>{const{drag:s,dragListener:i=!0}=this.getProps();s&&i&&this.start(t)})),n=()=>{const{dragConstraints:t}=this.getProps();u.isRefObject(t)&&t.current&&(this.constraints=this.resolveRefConstraints())},{projection:o}=this.visualElement,r=o.addEventListener("measure",n);o&&!o.layout&&(o.root&&o.root.updateScroll(),o.updateLayout()),d.frame.read(n);const l=s.addDomEvent(window,"resize",(()=>this.scalePositionWithinConstraints())),c=o.addEventListener("didUpdate",(({delta:t,hasLayoutChanged:s})=>{this.isDragging&&s&&(a.eachAxis((s=>{const i=this.getAxisMotionValue(s);i&&(this.originPoint[s]+=t[s].translate,i.set(i.get()+t[s].translate))})),this.visualElement.render())}));return()=>{l(),e(),r(),c&&c()}}getProps(){const t=this.visualElement.getProps(),{drag:s=!1,dragDirectionLock:i=!1,dragPropagation:e=!1,dragConstraints:n=!1,dragElastic:o=m.defaultElastic,dragMomentum:r=!0}=t;return{...t,drag:s,dragDirectionLock:i,dragPropagation:e,dragConstraints:n,dragElastic:o,dragMomentum:r}}},exports.elementDragControls=f;
//# sourceMappingURL=VisualElementDragControls.mjs.js.map
