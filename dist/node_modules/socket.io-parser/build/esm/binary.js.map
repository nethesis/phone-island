{"version":3,"file":"binary.js","sources":["../../../../../node_modules/socket.io-parser/build/esm/binary.js"],"sourcesContent":["import { isBinary } from \"./is-binary.js\";\n/**\n * Replaces every Buffer | ArrayBuffer | Blob | File in packet with a numbered placeholder.\n *\n * @param {Object} packet - socket.io event packet\n * @return {Object} with deconstructed packet and list of buffers\n * @public\n */\nexport function deconstructPacket(packet) {\n    const buffers = [];\n    const packetData = packet.data;\n    const pack = packet;\n    pack.data = _deconstructPacket(packetData, buffers);\n    pack.attachments = buffers.length; // number of binary 'attachments'\n    return { packet: pack, buffers: buffers };\n}\nfunction _deconstructPacket(data, buffers) {\n    if (!data)\n        return data;\n    if (isBinary(data)) {\n        const placeholder = { _placeholder: true, num: buffers.length };\n        buffers.push(data);\n        return placeholder;\n    }\n    else if (Array.isArray(data)) {\n        const newData = new Array(data.length);\n        for (let i = 0; i < data.length; i++) {\n            newData[i] = _deconstructPacket(data[i], buffers);\n        }\n        return newData;\n    }\n    else if (typeof data === \"object\" && !(data instanceof Date)) {\n        const newData = {};\n        for (const key in data) {\n            if (Object.prototype.hasOwnProperty.call(data, key)) {\n                newData[key] = _deconstructPacket(data[key], buffers);\n            }\n        }\n        return newData;\n    }\n    return data;\n}\n/**\n * Reconstructs a binary packet from its placeholder packet and buffers\n *\n * @param {Object} packet - event packet with placeholders\n * @param {Array} buffers - binary buffers to put in placeholder positions\n * @return {Object} reconstructed packet\n * @public\n */\nexport function reconstructPacket(packet, buffers) {\n    packet.data = _reconstructPacket(packet.data, buffers);\n    delete packet.attachments; // no longer useful\n    return packet;\n}\nfunction _reconstructPacket(data, buffers) {\n    if (!data)\n        return data;\n    if (data && data._placeholder === true) {\n        const isIndexValid = typeof data.num === \"number\" &&\n            data.num >= 0 &&\n            data.num < buffers.length;\n        if (isIndexValid) {\n            return buffers[data.num]; // appropriate buffer (should be natural order anyway)\n        }\n        else {\n            throw new Error(\"illegal attachments\");\n        }\n    }\n    else if (Array.isArray(data)) {\n        for (let i = 0; i < data.length; i++) {\n            data[i] = _reconstructPacket(data[i], buffers);\n        }\n    }\n    else if (typeof data === \"object\") {\n        for (const key in data) {\n            if (Object.prototype.hasOwnProperty.call(data, key)) {\n                data[key] = _reconstructPacket(data[key], buffers);\n            }\n        }\n    }\n    return data;\n}\n"],"names":["_deconstructPacket","data","buffers","isBinary","placeholder","_placeholder","num","length","push","Array","isArray","newData","i","Date","key","Object","prototype","hasOwnProperty","call","_reconstructPacket","Error","packet","packetData","pack","attachments"],"mappings":"oGAgBA,SAASA,EAAmBC,EAAMC,GAC9B,IAAKD,EACD,OAAOA,EACX,GAAIE,EAAAA,SAASF,GAAO,CAChB,MAAMG,EAAc,CAAEC,cAAc,EAAMC,IAAKJ,EAAQK,QAEvD,OADAL,EAAQM,KAAKP,GACNG,CACV,CACI,GAAIK,MAAMC,QAAQT,GAAO,CAC1B,MAAMU,EAAU,IAAIF,MAAMR,EAAKM,QAC/B,IAAK,IAAIK,EAAI,EAAGA,EAAIX,EAAKM,OAAQK,IAC7BD,EAAQC,GAAKZ,EAAmBC,EAAKW,GAAIV,GAE7C,OAAOS,CACX,CACK,GAAoB,iBAATV,KAAuBA,aAAgBY,MAAO,CAC1D,MAAMF,EAAU,CAAA,EAChB,IAAK,MAAMG,KAAOb,EACVc,OAAOC,UAAUC,eAAeC,KAAKjB,EAAMa,KAC3CH,EAAQG,GAAOd,EAAmBC,EAAKa,GAAMZ,IAGrD,OAAOS,CACX,CACA,OAAOV,CACX,CAcA,SAASkB,EAAmBlB,EAAMC,GAC9B,IAAKD,EACD,OAAOA,EACX,GAAIA,IAA8B,IAAtBA,EAAKI,aAAuB,CAIpC,GAHyC,iBAAbJ,EAAKK,KAC7BL,EAAKK,KAAO,GACZL,EAAKK,IAAMJ,EAAQK,OAEnB,OAAOL,EAAQD,EAAKK,KAGpB,MAAM,IAAIc,MAAM,sBAEvB,CACI,GAAIX,MAAMC,QAAQT,GACnB,IAAK,IAAIW,EAAI,EAAGA,EAAIX,EAAKM,OAAQK,IAC7BX,EAAKW,GAAKO,EAAmBlB,EAAKW,GAAIV,QAGzC,GAAoB,iBAATD,EACZ,IAAK,MAAMa,KAAOb,EACVc,OAAOC,UAAUC,eAAeC,KAAKjB,EAAMa,KAC3Cb,EAAKa,GAAOK,EAAmBlB,EAAKa,GAAMZ,IAItD,OAAOD,CACX,2BA1EO,SAA2BoB,GAC9B,MAAMnB,EAAU,GACVoB,EAAaD,EAAOpB,KACpBsB,EAAOF,EAGb,OAFAE,EAAKtB,KAAOD,EAAmBsB,EAAYpB,GAC3CqB,EAAKC,YAActB,EAAQK,OACpB,CAAEc,OAAQE,EAAMrB,QAASA,EACpC,4BAmCO,SAA2BmB,EAAQnB,GAGtC,OAFAmB,EAAOpB,KAAOkB,EAAmBE,EAAOpB,KAAMC,UACvCmB,EAAOG,YACPH,CACX"}