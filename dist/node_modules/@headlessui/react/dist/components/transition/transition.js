"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("../../hooks/use-disposables.js"),r=require("../../hooks/use-event.js"),n=require("../../hooks/use-is-mounted.js"),s=require("../../hooks/use-iso-morphic-effect.js"),i=require("../../hooks/use-latest-value.js"),l=require("../../hooks/use-server-handoff-complete.js"),u=require("../../hooks/use-sync-refs.js"),a=require("../../hooks/use-transition.js"),o=require("../../internal/open-closed.js"),d=require("../../utils/class-names.js"),c=require("../../utils/match.js"),f=require("../../utils/render.js");function v(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=v(e);function m(t){var r;return!!(t.enter||t.enterFrom||t.enterTo||t.leave||t.leaveFrom||t.leaveTo)||(null!=(r=t.as)?r:C)!==e.Fragment||1===h.default.Children.count(t.children)}let p=e.createContext(null);p.displayName="TransitionContext";var b,g=((b=g||{}).Visible="visible",b.Hidden="hidden",b);let E=e.createContext(null);function R(e){return"children"in e?R(e.children):e.current.filter((({el:e})=>null!==e.current)).filter((({state:e})=>"visible"===e)).length>0}function S(s,l){let u=i.useLatestValue(s),a=e.useRef([]),o=n.useIsMounted(),d=t.useDisposables(),v=r.useEvent(((e,t=f.RenderStrategy.Hidden)=>{let r=a.current.findIndex((({el:t})=>t===e));-1!==r&&(c.match(t,{[f.RenderStrategy.Unmount](){a.current.splice(r,1)},[f.RenderStrategy.Hidden](){a.current[r].state="hidden"}}),d.microTask((()=>{var e;!R(a)&&o.current&&(null==(e=u.current)||e.call(u))})))})),h=r.useEvent((e=>{let t=a.current.find((({el:t})=>t===e));return t?"visible"!==t.state&&(t.state="visible"):a.current.push({el:e,state:"visible"}),()=>v(e,f.RenderStrategy.Unmount)})),m=e.useRef([]),p=e.useRef(Promise.resolve()),b=e.useRef({enter:[],leave:[]}),g=r.useEvent(((e,t,r)=>{m.current.splice(0),l&&(l.chains.current[t]=l.chains.current[t].filter((([t])=>t!==e))),null==l||l.chains.current[t].push([e,new Promise((e=>{m.current.push(e)}))]),null==l||l.chains.current[t].push([e,new Promise((e=>{Promise.all(b.current[t].map((([e,t])=>t))).then((()=>e()))}))]),"enter"===t?p.current=p.current.then((()=>null==l?void 0:l.wait.current)).then((()=>r(t))):r(t)})),E=r.useEvent(((e,t,r)=>{Promise.all(b.current[t].splice(0).map((([e,t])=>t))).then((()=>{var e;null==(e=m.current.shift())||e()})).then((()=>r(t)))}));return e.useMemo((()=>({children:a,register:h,unregister:v,onStart:g,onStop:E,wait:p,chains:b})),[h,v,a,g,E,b,p])}E.displayName="NestingContext";let C=e.Fragment,T=f.RenderFeatures.RenderStrategy;let w=f.forwardRefWithAs((function(t,n){let{show:i,appear:a=!1,unmount:d=!0,...c}=t,v=e.useRef(null),b=m(t),g=u.useSyncRefs(...b?[v,n]:null===n?[]:[n]);l.useServerHandoffComplete();let C=o.useOpenClosed();if(void 0===i&&null!==C&&(i=(C&o.State.Open)===o.State.Open),void 0===i)throw new Error("A <Transition /> is used but it is missing a `show={true | false}` prop.");let[w,j]=e.useState(i?"visible":"hidden"),P=S((()=>{i||j("hidden")})),[q,x]=e.useState(!0),F=e.useRef([i]);s.useIsoMorphicEffect((()=>{!1!==q&&F.current[F.current.length-1]!==i&&(F.current.push(i),x(!1))}),[F,i]);let M=e.useMemo((()=>({show:i,appear:a,initial:q})),[i,a,q]);s.useIsoMorphicEffect((()=>{i?j("visible"):!R(P)&&null!==v.current&&j("hidden")}),[i,P]);let O={unmount:d},k=r.useEvent((()=>{var e;q&&x(!1),null==(e=t.beforeEnter)||e.call(t)})),A=r.useEvent((()=>{var e;q&&x(!1),null==(e=t.beforeLeave)||e.call(t)})),H=f.useRender();return h.default.createElement(E.Provider,{value:P},h.default.createElement(p.Provider,{value:M},H({ourProps:{...O,as:e.Fragment,children:h.default.createElement(y,{ref:g,...O,...c,beforeEnter:k,beforeLeave:A})},theirProps:{},defaultTag:e.Fragment,features:T,visible:"visible"===w,name:"Transition"})))})),y=f.forwardRefWithAs((function(t,n){var i,v;let{transition:b=!0,beforeEnter:g,afterEnter:w,beforeLeave:y,afterLeave:j,enter:P,enterFrom:q,enterTo:x,entered:F,leave:M,leaveFrom:O,leaveTo:k,...A}=t,[H,I]=e.useState(null),N=e.useRef(null),L=m(t),D=u.useSyncRefs(...L?[N,n,I]:null===n?[]:[n]),U=null==(i=A.unmount)||i?f.RenderStrategy.Unmount:f.RenderStrategy.Hidden,{show:W,appear:V,initial:_}=function(){let t=e.useContext(p);if(null===t)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return t}(),[z,B]=e.useState(W?"visible":"hidden"),G=function(){let t=e.useContext(E);if(null===t)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return t}(),{register:J,unregister:K}=G;s.useIsoMorphicEffect((()=>J(N)),[J,N]),s.useIsoMorphicEffect((()=>{if(U===f.RenderStrategy.Hidden&&N.current)return W&&"visible"!==z?void B("visible"):c.match(z,{hidden:()=>K(N),visible:()=>J(N)})}),[z,N,J,K,W,U]);let Q=l.useServerHandoffComplete();s.useIsoMorphicEffect((()=>{if(L&&Q&&"visible"===z&&null===N.current)throw new Error("Did you forget to passthrough the `ref` to the actual DOM node?")}),[N,z,Q,L]);let X=_&&!V,Y=V&&W&&_,Z=e.useRef(!1),$=S((()=>{Z.current||(B("hidden"),K(N))}),G),ee=r.useEvent((e=>{Z.current=!0;let t=e?"enter":"leave";$.onStart(N,t,(e=>{"enter"===e?null==g||g():"leave"===e&&(null==y||y())}))})),te=r.useEvent((e=>{let t=e?"enter":"leave";Z.current=!1,$.onStop(N,t,(e=>{"enter"===e?null==w||w():"leave"===e&&(null==j||j())})),"leave"===t&&!R($)&&(B("hidden"),K(N))}));e.useEffect((()=>{L&&b||(ee(W),te(W))}),[W,L,b]);let re=!(!b||!L||!Q||X),[,ne]=a.useTransition(re,H,W,{start:ee,end:te}),se=f.compact({ref:D,className:(null==(v=d.classNames(A.className,Y&&P,Y&&q,ne.enter&&P,ne.enter&&ne.closed&&q,ne.enter&&!ne.closed&&x,ne.leave&&M,ne.leave&&!ne.closed&&O,ne.leave&&ne.closed&&k,!ne.transition&&W&&F))?void 0:v.trim())||void 0,...a.transitionDataAttributes(ne)}),ie=0;"visible"===z&&(ie|=o.State.Open),"hidden"===z&&(ie|=o.State.Closed),ne.enter&&(ie|=o.State.Opening),ne.leave&&(ie|=o.State.Closing);let le=f.useRender();return h.default.createElement(E.Provider,{value:$},h.default.createElement(o.OpenClosedProvider,{value:ie},le({ourProps:se,theirProps:A,defaultTag:C,features:T,visible:"visible"===z,name:"Transition.Child"})))})),j=f.forwardRefWithAs((function(t,r){let n=null!==e.useContext(p),s=null!==o.useOpenClosed();return h.default.createElement(h.default.Fragment,null,!n&&s?h.default.createElement(w,{ref:r,...t}):h.default.createElement(y,{ref:r,...t}))})),P=Object.assign(w,{Child:j,Root:w});exports.Transition=P,exports.TransitionChild=j;
//# sourceMappingURL=transition.js.map
