{"version":3,"file":"getusermedia.js","sources":["../../../../../../node_modules/webrtc-adapter/src/js/chrome/getusermedia.js"],"sourcesContent":["/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n/* eslint-env node */\n'use strict';\nimport * as utils from '../utils.js';\nconst logging = utils.log;\n\nexport function shimGetUserMedia(window, browserDetails) {\n  const navigator = window && window.navigator;\n\n  if (!navigator.mediaDevices) {\n    return;\n  }\n\n  const constraintsToChrome_ = function(c) {\n    if (typeof c !== 'object' || c.mandatory || c.optional) {\n      return c;\n    }\n    const cc = {};\n    Object.keys(c).forEach(key => {\n      if (key === 'require' || key === 'advanced' || key === 'mediaSource') {\n        return;\n      }\n      const r = (typeof c[key] === 'object') ? c[key] : {ideal: c[key]};\n      if (r.exact !== undefined && typeof r.exact === 'number') {\n        r.min = r.max = r.exact;\n      }\n      const oldname_ = function(prefix, name) {\n        if (prefix) {\n          return prefix + name.charAt(0).toUpperCase() + name.slice(1);\n        }\n        return (name === 'deviceId') ? 'sourceId' : name;\n      };\n      if (r.ideal !== undefined) {\n        cc.optional = cc.optional || [];\n        let oc = {};\n        if (typeof r.ideal === 'number') {\n          oc[oldname_('min', key)] = r.ideal;\n          cc.optional.push(oc);\n          oc = {};\n          oc[oldname_('max', key)] = r.ideal;\n          cc.optional.push(oc);\n        } else {\n          oc[oldname_('', key)] = r.ideal;\n          cc.optional.push(oc);\n        }\n      }\n      if (r.exact !== undefined && typeof r.exact !== 'number') {\n        cc.mandatory = cc.mandatory || {};\n        cc.mandatory[oldname_('', key)] = r.exact;\n      } else {\n        ['min', 'max'].forEach(mix => {\n          if (r[mix] !== undefined) {\n            cc.mandatory = cc.mandatory || {};\n            cc.mandatory[oldname_(mix, key)] = r[mix];\n          }\n        });\n      }\n    });\n    if (c.advanced) {\n      cc.optional = (cc.optional || []).concat(c.advanced);\n    }\n    return cc;\n  };\n\n  const shimConstraints_ = function(constraints, func) {\n    if (browserDetails.version >= 61) {\n      return func(constraints);\n    }\n    constraints = JSON.parse(JSON.stringify(constraints));\n    if (constraints && typeof constraints.audio === 'object') {\n      const remap = function(obj, a, b) {\n        if (a in obj && !(b in obj)) {\n          obj[b] = obj[a];\n          delete obj[a];\n        }\n      };\n      constraints = JSON.parse(JSON.stringify(constraints));\n      remap(constraints.audio, 'autoGainControl', 'googAutoGainControl');\n      remap(constraints.audio, 'noiseSuppression', 'googNoiseSuppression');\n      constraints.audio = constraintsToChrome_(constraints.audio);\n    }\n    if (constraints && typeof constraints.video === 'object') {\n      // Shim facingMode for mobile & surface pro.\n      let face = constraints.video.facingMode;\n      face = face && ((typeof face === 'object') ? face : {ideal: face});\n      const getSupportedFacingModeLies = browserDetails.version < 66;\n\n      if ((face && (face.exact === 'user' || face.exact === 'environment' ||\n                    face.ideal === 'user' || face.ideal === 'environment')) &&\n          !(navigator.mediaDevices.getSupportedConstraints &&\n            navigator.mediaDevices.getSupportedConstraints().facingMode &&\n            !getSupportedFacingModeLies)) {\n        delete constraints.video.facingMode;\n        let matches;\n        if (face.exact === 'environment' || face.ideal === 'environment') {\n          matches = ['back', 'rear'];\n        } else if (face.exact === 'user' || face.ideal === 'user') {\n          matches = ['front'];\n        }\n        if (matches) {\n          // Look for matches in label, or use last cam for back (typical).\n          return navigator.mediaDevices.enumerateDevices()\n            .then(devices => {\n              devices = devices.filter(d => d.kind === 'videoinput');\n              let dev = devices.find(d => matches.some(match =>\n                d.label.toLowerCase().includes(match)));\n              if (!dev && devices.length && matches.includes('back')) {\n                dev = devices[devices.length - 1]; // more likely the back cam\n              }\n              if (dev) {\n                constraints.video.deviceId = face.exact\n                  ? {exact: dev.deviceId}\n                  : {ideal: dev.deviceId};\n              }\n              constraints.video = constraintsToChrome_(constraints.video);\n              logging('chrome: ' + JSON.stringify(constraints));\n              return func(constraints);\n            });\n        }\n      }\n      constraints.video = constraintsToChrome_(constraints.video);\n    }\n    logging('chrome: ' + JSON.stringify(constraints));\n    return func(constraints);\n  };\n\n  const shimError_ = function(e) {\n    if (browserDetails.version >= 64) {\n      return e;\n    }\n    return {\n      name: {\n        PermissionDeniedError: 'NotAllowedError',\n        PermissionDismissedError: 'NotAllowedError',\n        InvalidStateError: 'NotAllowedError',\n        DevicesNotFoundError: 'NotFoundError',\n        ConstraintNotSatisfiedError: 'OverconstrainedError',\n        TrackStartError: 'NotReadableError',\n        MediaDeviceFailedDueToShutdown: 'NotAllowedError',\n        MediaDeviceKillSwitchOn: 'NotAllowedError',\n        TabCaptureError: 'AbortError',\n        ScreenCaptureError: 'AbortError',\n        DeviceCaptureError: 'AbortError'\n      }[e.name] || e.name,\n      message: e.message,\n      constraint: e.constraint || e.constraintName,\n      toString() {\n        return this.name + (this.message && ': ') + this.message;\n      }\n    };\n  };\n\n  const getUserMedia_ = function(constraints, onSuccess, onError) {\n    shimConstraints_(constraints, c => {\n      navigator.webkitGetUserMedia(c, onSuccess, e => {\n        if (onError) {\n          onError(shimError_(e));\n        }\n      });\n    });\n  };\n  navigator.getUserMedia = getUserMedia_.bind(navigator);\n\n  // Even though Chrome 45 has navigator.mediaDevices and a getUserMedia\n  // function which returns a Promise, it does not accept spec-style\n  // constraints.\n  if (navigator.mediaDevices.getUserMedia) {\n    const origGetUserMedia = navigator.mediaDevices.getUserMedia.\n      bind(navigator.mediaDevices);\n    navigator.mediaDevices.getUserMedia = function(cs) {\n      return shimConstraints_(cs, c => origGetUserMedia(c).then(stream => {\n        if (c.audio && !stream.getAudioTracks().length ||\n            c.video && !stream.getVideoTracks().length) {\n          stream.getTracks().forEach(track => {\n            track.stop();\n          });\n          throw new DOMException('', 'NotFoundError');\n        }\n        return stream;\n      }, e => Promise.reject(shimError_(e))));\n    };\n  }\n}\n"],"names":["logging","utils","window","browserDetails","navigator","mediaDevices","constraintsToChrome_","c","mandatory","optional","cc","Object","keys","forEach","key","r","ideal","undefined","exact","min","max","oldname_","prefix","name","charAt","toUpperCase","slice","oc","push","mix","advanced","concat","shimConstraints_","constraints","func","version","JSON","parse","stringify","audio","remap","obj","a","b","video","face","facingMode","getSupportedFacingModeLies","getSupportedConstraints","matches","enumerateDevices","then","devices","dev","filter","d","kind","find","some","match","label","toLowerCase","includes","length","deviceId","shimError_","e","PermissionDeniedError","PermissionDismissedError","InvalidStateError","DevicesNotFoundError","ConstraintNotSatisfiedError","TrackStartError","MediaDeviceFailedDueToShutdown","MediaDeviceKillSwitchOn","TabCaptureError","ScreenCaptureError","DeviceCaptureError","message","constraint","constraintName","toString","this","getUserMedia","onSuccess","onError","webkitGetUserMedia","bind","origGetUserMedia","cs","stream","getAudioTracks","getVideoTracks","getTracks","track","stop","DOMException","Promise","reject"],"mappings":"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"}