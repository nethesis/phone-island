{"version":3,"file":"utils.js","sources":["../../../../../node_modules/webrtc-adapter/src/js/utils.js"],"sourcesContent":["/*\n *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.\n *\n *  Use of this source code is governed by a BSD-style license\n *  that can be found in the LICENSE file in the root of the source\n *  tree.\n */\n/* eslint-env node */\n'use strict';\n\nlet logDisabled_ = true;\nlet deprecationWarnings_ = true;\n\n/**\n * Extract browser version out of the provided user agent string.\n *\n * @param {!string} uastring userAgent string.\n * @param {!string} expr Regular expression used as match criteria.\n * @param {!number} pos position in the version string to be returned.\n * @return {!number} browser version.\n */\nexport function extractVersion(uastring, expr, pos) {\n  const match = uastring.match(expr);\n  return match && match.length >= pos && parseInt(match[pos], 10);\n}\n\n// Wraps the peerconnection event eventNameToWrap in a function\n// which returns the modified event object (or false to prevent\n// the event).\nexport function wrapPeerConnectionEvent(window, eventNameToWrap, wrapper) {\n  if (!window.RTCPeerConnection) {\n    return;\n  }\n  const proto = window.RTCPeerConnection.prototype;\n  const nativeAddEventListener = proto.addEventListener;\n  proto.addEventListener = function(nativeEventName, cb) {\n    if (nativeEventName !== eventNameToWrap) {\n      return nativeAddEventListener.apply(this, arguments);\n    }\n    const wrappedCallback = (e) => {\n      const modifiedEvent = wrapper(e);\n      if (modifiedEvent) {\n        if (cb.handleEvent) {\n          cb.handleEvent(modifiedEvent);\n        } else {\n          cb(modifiedEvent);\n        }\n      }\n    };\n    this._eventMap = this._eventMap || {};\n    if (!this._eventMap[eventNameToWrap]) {\n      this._eventMap[eventNameToWrap] = new Map();\n    }\n    this._eventMap[eventNameToWrap].set(cb, wrappedCallback);\n    return nativeAddEventListener.apply(this, [nativeEventName,\n      wrappedCallback]);\n  };\n\n  const nativeRemoveEventListener = proto.removeEventListener;\n  proto.removeEventListener = function(nativeEventName, cb) {\n    if (nativeEventName !== eventNameToWrap || !this._eventMap\n        || !this._eventMap[eventNameToWrap]) {\n      return nativeRemoveEventListener.apply(this, arguments);\n    }\n    if (!this._eventMap[eventNameToWrap].has(cb)) {\n      return nativeRemoveEventListener.apply(this, arguments);\n    }\n    const unwrappedCb = this._eventMap[eventNameToWrap].get(cb);\n    this._eventMap[eventNameToWrap].delete(cb);\n    if (this._eventMap[eventNameToWrap].size === 0) {\n      delete this._eventMap[eventNameToWrap];\n    }\n    if (Object.keys(this._eventMap).length === 0) {\n      delete this._eventMap;\n    }\n    return nativeRemoveEventListener.apply(this, [nativeEventName,\n      unwrappedCb]);\n  };\n\n  Object.defineProperty(proto, 'on' + eventNameToWrap, {\n    get() {\n      return this['_on' + eventNameToWrap];\n    },\n    set(cb) {\n      if (this['_on' + eventNameToWrap]) {\n        this.removeEventListener(eventNameToWrap,\n          this['_on' + eventNameToWrap]);\n        delete this['_on' + eventNameToWrap];\n      }\n      if (cb) {\n        this.addEventListener(eventNameToWrap,\n          this['_on' + eventNameToWrap] = cb);\n      }\n    },\n    enumerable: true,\n    configurable: true\n  });\n}\n\nexport function disableLog(bool) {\n  if (typeof bool !== 'boolean') {\n    return new Error('Argument type: ' + typeof bool +\n        '. Please use a boolean.');\n  }\n  logDisabled_ = bool;\n  return (bool) ? 'adapter.js logging disabled' :\n    'adapter.js logging enabled';\n}\n\n/**\n * Disable or enable deprecation warnings\n * @param {!boolean} bool set to true to disable warnings.\n */\nexport function disableWarnings(bool) {\n  if (typeof bool !== 'boolean') {\n    return new Error('Argument type: ' + typeof bool +\n        '. Please use a boolean.');\n  }\n  deprecationWarnings_ = !bool;\n  return 'adapter.js deprecation warnings ' + (bool ? 'disabled' : 'enabled');\n}\n\nexport function log() {\n  if (typeof window === 'object') {\n    if (logDisabled_) {\n      return;\n    }\n    if (typeof console !== 'undefined' && typeof console.log === 'function') {\n      console.log.apply(console, arguments);\n    }\n  }\n}\n\n/**\n * Shows a deprecation warning suggesting the modern and spec-compatible API.\n */\nexport function deprecated(oldMethod, newMethod) {\n  if (!deprecationWarnings_) {\n    return;\n  }\n  console.warn(oldMethod + ' is deprecated, please use ' + newMethod +\n      ' instead.');\n}\n\n/**\n * Browser detector.\n *\n * @return {object} result containing browser and version\n *     properties.\n */\nexport function detectBrowser(window) {\n  // Returned result object.\n  const result = {browser: null, version: null};\n\n  // Fail early if it's not a browser\n  if (typeof window === 'undefined' || !window.navigator ||\n      !window.navigator.userAgent) {\n    result.browser = 'Not a browser.';\n    return result;\n  }\n\n  const {navigator} = window;\n\n  // Prefer navigator.userAgentData.\n  if (navigator.userAgentData && navigator.userAgentData.brands) {\n    const chromium = navigator.userAgentData.brands.find((brand) => {\n      return brand.brand === 'Chromium';\n    });\n    if (chromium) {\n      return {browser: 'chrome', version: parseInt(chromium.version, 10)};\n    }\n  }\n\n  if (navigator.mozGetUserMedia) { // Firefox.\n    result.browser = 'firefox';\n    result.version = extractVersion(navigator.userAgent,\n      /Firefox\\/(\\d+)\\./, 1);\n  } else if (navigator.webkitGetUserMedia ||\n      (window.isSecureContext === false && window.webkitRTCPeerConnection)) {\n    // Chrome, Chromium, Webview, Opera.\n    // Version matches Chrome/WebRTC version.\n    // Chrome 74 removed webkitGetUserMedia on http as well so we need the\n    // more complicated fallback to webkitRTCPeerConnection.\n    result.browser = 'chrome';\n    result.version = extractVersion(navigator.userAgent,\n      /Chrom(e|ium)\\/(\\d+)\\./, 2);\n  } else if (window.RTCPeerConnection &&\n      navigator.userAgent.match(/AppleWebKit\\/(\\d+)\\./)) { // Safari.\n    result.browser = 'safari';\n    result.version = extractVersion(navigator.userAgent,\n      /AppleWebKit\\/(\\d+)\\./, 1);\n    result.supportsUnifiedPlan = window.RTCRtpTransceiver &&\n        'currentDirection' in window.RTCRtpTransceiver.prototype;\n  } else { // Default fallthrough: not supported.\n    result.browser = 'Not a supported browser.';\n    return result;\n  }\n\n  return result;\n}\n\n/**\n * Checks if something is an object.\n *\n * @param {*} val The something you want to check.\n * @return true if val is an object, false otherwise.\n */\nfunction isObject(val) {\n  return Object.prototype.toString.call(val) === '[object Object]';\n}\n\n/**\n * Remove all empty objects and undefined values\n * from a nested object -- an enhanced and vanilla version\n * of Lodash's `compact`.\n */\nexport function compactObject(data) {\n  if (!isObject(data)) {\n    return data;\n  }\n\n  return Object.keys(data).reduce(function(accumulator, key) {\n    const isObj = isObject(data[key]);\n    const value = isObj ? compactObject(data[key]) : data[key];\n    const isEmptyObject = isObj && !Object.keys(value).length;\n    if (value === undefined || isEmptyObject) {\n      return accumulator;\n    }\n    return Object.assign(accumulator, {[key]: value});\n  }, {});\n}\n\n/* iterates the stats graph recursively. */\nexport function walkStats(stats, base, resultSet) {\n  if (!base || resultSet.has(base.id)) {\n    return;\n  }\n  resultSet.set(base.id, base);\n  Object.keys(base).forEach(name => {\n    if (name.endsWith('Id')) {\n      walkStats(stats, stats.get(base[name]), resultSet);\n    } else if (name.endsWith('Ids')) {\n      base[name].forEach(id => {\n        walkStats(stats, stats.get(id), resultSet);\n      });\n    }\n  });\n}\n\n/* filter getStats for a sender/receiver track. */\nexport function filterStats(result, track, outbound) {\n  const streamStatsType = outbound ? 'outbound-rtp' : 'inbound-rtp';\n  const filteredResult = new Map();\n  if (track === null) {\n    return filteredResult;\n  }\n  const trackStats = [];\n  result.forEach(value => {\n    if (value.type === 'track' &&\n        value.trackIdentifier === track.id) {\n      trackStats.push(value);\n    }\n  });\n  trackStats.forEach(trackStat => {\n    result.forEach(stats => {\n      if (stats.type === streamStatsType && stats.trackId === trackStat.id) {\n        walkStats(result, stats, filteredResult);\n      }\n    });\n  });\n  return filteredResult;\n}\n\n"],"names":["logDisabled_","deprecationWarnings_","extractVersion","uastring","expr","pos","match","length","parseInt","isObject","val","Object","prototype","toString","call","walkStats","stats","base","resultSet","has","id","set","keys","forEach","name","endsWith","get","compactObject","data","reduce","accumulator","key","isObj","value","isEmptyObject","undefined","assign","oldMethod","newMethod","console","warn","window","result","browser","version","navigator","userAgent","userAgentData","brands","chromium","find","brand","mozGetUserMedia","webkitGetUserMedia","isSecureContext","webkitRTCPeerConnection","RTCPeerConnection","supportsUnifiedPlan","RTCRtpTransceiver","bool","Error","track","outbound","streamStatsType","filteredResult","Map","trackStats","type","trackIdentifier","push","trackStat","trackId","log","apply","arguments","eventNameToWrap","wrapper","proto","nativeAddEventListener","addEventListener","nativeEventName","cb","this","wrappedCallback","e","modifiedEvent","handleEvent","_eventMap","nativeRemoveEventListener","removeEventListener","unwrappedCb","delete","size","defineProperty","enumerable","configurable"],"mappings":"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"}