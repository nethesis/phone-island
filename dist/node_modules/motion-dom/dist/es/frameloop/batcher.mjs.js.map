{"version":3,"file":"batcher.mjs.js","sources":["../../../../../../node_modules/motion-dom/dist/es/frameloop/batcher.mjs"],"sourcesContent":["import { MotionGlobalConfig } from 'motion-utils';\nimport { stepsOrder } from './order.mjs';\nimport { createRenderStep } from './render-step.mjs';\n\nconst maxElapsed = 40;\nfunction createRenderBatcher(scheduleNextBatch, allowKeepAlive) {\n    let runNextFrame = false;\n    let useDefaultElapsed = true;\n    const state = {\n        delta: 0.0,\n        timestamp: 0.0,\n        isProcessing: false,\n    };\n    const flagRunNextFrame = () => (runNextFrame = true);\n    const steps = stepsOrder.reduce((acc, key) => {\n        acc[key] = createRenderStep(flagRunNextFrame, allowKeepAlive ? key : undefined);\n        return acc;\n    }, {});\n    const { setup, read, resolveKeyframes, preUpdate, update, preRender, render, postRender, } = steps;\n    const processBatch = () => {\n        const timestamp = MotionGlobalConfig.useManualTiming\n            ? state.timestamp\n            : performance.now();\n        runNextFrame = false;\n        if (!MotionGlobalConfig.useManualTiming) {\n            state.delta = useDefaultElapsed\n                ? 1000 / 60\n                : Math.max(Math.min(timestamp - state.timestamp, maxElapsed), 1);\n        }\n        state.timestamp = timestamp;\n        state.isProcessing = true;\n        // Unrolled render loop for better per-frame performance\n        setup.process(state);\n        read.process(state);\n        resolveKeyframes.process(state);\n        preUpdate.process(state);\n        update.process(state);\n        preRender.process(state);\n        render.process(state);\n        postRender.process(state);\n        state.isProcessing = false;\n        if (runNextFrame && allowKeepAlive) {\n            useDefaultElapsed = false;\n            scheduleNextBatch(processBatch);\n        }\n    };\n    const wake = () => {\n        runNextFrame = true;\n        useDefaultElapsed = true;\n        if (!state.isProcessing) {\n            scheduleNextBatch(processBatch);\n        }\n    };\n    const schedule = stepsOrder.reduce((acc, key) => {\n        const step = steps[key];\n        acc[key] = (process, keepAlive = false, immediate = false) => {\n            if (!runNextFrame)\n                wake();\n            return step.schedule(process, keepAlive, immediate);\n        };\n        return acc;\n    }, {});\n    const cancel = (process) => {\n        for (let i = 0; i < stepsOrder.length; i++) {\n            steps[stepsOrder[i]].cancel(process);\n        }\n    };\n    return { schedule, cancel, state, steps };\n}\n\nexport { createRenderBatcher };\n"],"names":["scheduleNextBatch","allowKeepAlive","runNextFrame","useDefaultElapsed","state","delta","timestamp","isProcessing","flagRunNextFrame","steps","stepsOrder","reduce","acc","key","createRenderStep","undefined","setup","read","resolveKeyframes","preUpdate","update","preRender","render","postRender","processBatch","MotionGlobalConfig","useManualTiming","performance","now","Math","max","min","process","schedule","step","keepAlive","immediate","cancel","i","length"],"mappings":"qOAKA,SAA6BA,EAAmBC,GAC5C,IAAIC,GAAe,EACfC,GAAoB,EACxB,MAAMC,EAAQ,CACVC,MAAO,EACPC,UAAW,EACXC,cAAc,GAEZC,EAAmBA,IAAON,GAAe,EACzCO,EAAQC,EAAUA,WAACC,QAAO,CAACC,EAAKC,KAClCD,EAAIC,GAAOC,EAAgBA,iBAACN,EAAkBP,EAAiBY,OAAME,GAC9DH,IACR,CAAE,IACCI,MAAEA,EAAKC,KAAEA,EAAIC,iBAAEA,EAAgBC,UAAEA,EAASC,OAAEA,EAAMC,UAAEA,EAASC,OAAEA,EAAMC,WAAEA,GAAgBd,EACvFe,EAAeA,KACjB,MAAMlB,EAAYmB,EAAAA,mBAAmBC,gBAC/BtB,EAAME,UACNqB,YAAYC,MAClB1B,GAAe,EACVuB,EAAkBA,mBAACC,kBACpBtB,EAAMC,MAAQF,EACR,IAAO,GACP0B,KAAKC,IAAID,KAAKE,IAAIzB,EAAYF,EAAME,UAvBnC,IAuB2D,IAEtEF,EAAME,UAAYA,EAClBF,EAAMG,cAAe,EAErBS,EAAMgB,QAAQ5B,GACda,EAAKe,QAAQ5B,GACbc,EAAiBc,QAAQ5B,GACzBe,EAAUa,QAAQ5B,GAClBgB,EAAOY,QAAQ5B,GACfiB,EAAUW,QAAQ5B,GAClBkB,EAAOU,QAAQ5B,GACfmB,EAAWS,QAAQ5B,GACnBA,EAAMG,cAAe,EACjBL,GAAgBD,IAChBE,GAAoB,EACpBH,EAAkBwB,GACtB,EAuBJ,MAAO,CAAES,SAdQvB,EAAUA,WAACC,QAAO,CAACC,EAAKC,KACrC,MAAMqB,EAAOzB,EAAMI,GAMnB,OALAD,EAAIC,GAAO,CAACmB,EAASG,GAAY,EAAOC,GAAY,KAC3ClC,IATTA,GAAe,EACfC,GAAoB,EACfC,EAAMG,cACPP,EAAkBwB,IAQXU,EAAKD,SAASD,EAASG,EAAWC,IAEtCxB,CAAG,GACX,CAAE,GAMcyB,OALHL,IACZ,IAAK,IAAIM,EAAI,EAAGA,EAAI5B,EAAAA,WAAW6B,OAAQD,IACnC7B,EAAMC,EAAUA,WAAC4B,IAAID,OAAOL,EAChC,EAEuB5B,QAAOK,QACtC"}