"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../frameloop/sync-time.mjs.js"),e=require("../stats/animation-count.mjs.js"),i=require("../utils/mix/index.mjs.js"),s=require("./drivers/driver-frameloop.mjs.js"),r=require("./generators/inertia.mjs.js"),n=require("./generators/keyframes.mjs.js"),a=require("./generators/utils/calc-duration.mjs.js"),o=require("./keyframes/get-final.mjs.js"),h=require("./utils/replace-transition-type.mjs.js"),l=require("./utils/WithPromise.mjs.js"),m=require("../../../../motion-utils/dist/es/errors.mjs.js"),u=require("../../../../motion-utils/dist/es/pipe.mjs.js"),d=require("../../../../motion-utils/dist/es/time-conversion.mjs.js"),p=require("../../../../motion-utils/dist/es/clamp.mjs.js");const c=t=>t/100;class T extends l.WithPromise{constructor(i){super(),this.state="idle",this.startTime=null,this.isStopped=!1,this.currentTime=0,this.holdTime=null,this.playbackSpeed=1,this.stop=()=>{const{motionValue:e}=this.options;if(e&&e.updatedAt!==t.time.now()&&this.tick(t.time.now()),this.isStopped=!0,"idle"===this.state)return;this.teardown();const{onStop:i}=this.options;i&&i()},e.activeAnimations.mainThread++,this.options=i,this.initAnimation(),this.play(),!1===i.autoplay&&this.pause()}initAnimation(){const{options:t}=this;h.replaceTransitionType(t);const{type:e=n.keyframes,repeat:s=0,repeatDelay:r=0,repeatType:o,velocity:l=0}=t;let{keyframes:d}=t;const p=e||n.keyframes;"production"!==process.env.NODE_ENV&&p!==n.keyframes&&m.invariant(d.length<=2,`Only two keyframes currently supported with spring and inertia animations. Trying to animate ${d}`),p!==n.keyframes&&"number"!=typeof d[0]&&(this.mixKeyframes=u.pipe(c,i.mix(d[0],d[1])),d=[0,100]);const T=p({...t,keyframes:d});"mirror"===o&&(this.mirroredGenerator=p({...t,keyframes:[...d].reverse(),velocity:-l})),null===T.calculatedDuration&&(T.calculatedDuration=a.calcGeneratorDuration(T));const{calculatedDuration:y}=T;this.calculatedDuration=y,this.resolvedDuration=y+r,this.totalDuration=this.resolvedDuration*(s+1)-r,this.generator=T}updateTime(t){const e=Math.round(t-this.startTime)*this.playbackSpeed;null!==this.holdTime?this.currentTime=this.holdTime:this.currentTime=e}tick(t,e=!1){const{generator:i,totalDuration:s,mixKeyframes:n,mirroredGenerator:a,resolvedDuration:h,calculatedDuration:l}=this;if(null===this.startTime)return i.next(0);const{delay:m=0,keyframes:u,repeat:d,repeatType:c,repeatDelay:T,type:y,onUpdate:f,finalKeyframe:v}=this.options;this.speed>0?this.startTime=Math.min(this.startTime,t):this.speed<0&&(this.startTime=Math.min(t-s/this.speed,this.startTime)),e?this.currentTime=t:this.updateTime(t);const j=this.currentTime-m*(this.playbackSpeed>=0?1:-1),k=this.playbackSpeed>=0?j<0:j>s;this.currentTime=Math.max(j,0),"finished"===this.state&&null===this.holdTime&&(this.currentTime=s);let D=this.currentTime,S=i;if(d){const t=Math.min(this.currentTime,s)/h;let e=Math.floor(t),i=t%1;!i&&t>=1&&(i=1),1===i&&e--,e=Math.min(e,d+1);Boolean(e%2)&&("reverse"===c?(i=1-i,T&&(i-=T/h)):"mirror"===c&&(S=a)),D=p.clamp(0,1,i)*h}const g=k?{done:!1,value:u[0]}:S.next(D);n&&(g.value=n(g.value));let{done:q}=g;k||null===l||(q=this.playbackSpeed>=0?this.currentTime>=s:this.currentTime<=0);const b=null===this.holdTime&&("finished"===this.state||"running"===this.state&&q);return b&&y!==r.inertia&&(g.value=o.getFinalKeyframe(u,this.options,v,this.speed)),f&&f(g.value),b&&this.finish(),g}then(t,e){return this.finished.then(t,e)}get duration(){return d.millisecondsToSeconds(this.calculatedDuration)}get time(){return d.millisecondsToSeconds(this.currentTime)}set time(t){t=d.secondsToMilliseconds(t),this.currentTime=t,null===this.startTime||null!==this.holdTime||0===this.playbackSpeed?this.holdTime=t:this.driver&&(this.startTime=this.driver.now()-t/this.playbackSpeed)}get speed(){return this.playbackSpeed}set speed(e){this.updateTime(t.time.now());const i=this.playbackSpeed!==e;this.playbackSpeed=e,i&&(this.time=d.millisecondsToSeconds(this.currentTime))}play(){if(this.isStopped)return;const{driver:t=s.frameloopDriver,onPlay:e,startTime:i}=this.options;this.driver||(this.driver=t((t=>this.tick(t)))),e&&e();const r=this.driver.now();"finished"===this.state?(this.updateFinished(),this.startTime=r):null!==this.holdTime?this.startTime=r-this.holdTime:this.startTime||(this.startTime=i??r),"finished"===this.state&&this.speed<0&&(this.startTime+=this.calculatedDuration),this.holdTime=null,this.state="running",this.driver.start()}pause(){this.state="paused",this.updateTime(t.time.now()),this.holdTime=this.currentTime}complete(){"running"!==this.state&&this.play(),this.state="finished",this.holdTime=null}finish(){this.teardown(),this.state="finished";const{onComplete:t}=this.options;t&&t()}cancel(){this.holdTime=null,this.startTime=0,this.tick(0),this.teardown()}teardown(){this.notifyFinished(),this.state="idle",this.stopDriver(),this.startTime=this.holdTime=null,e.activeAnimations.mainThread--}stopDriver(){this.driver&&(this.driver.stop(),this.driver=void 0)}sample(t){return this.startTime=0,this.tick(t,!0)}attachTimeline(t){return this.options.allowFlatten&&(this.options.type="keyframes",this.options.ease="linear",this.initAnimation()),t.observe(this)}}exports.JSAnimation=T;
//# sourceMappingURL=JSAnimation.mjs.js.map
