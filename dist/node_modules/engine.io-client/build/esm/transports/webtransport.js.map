{"version":3,"file":"webtransport.js","sources":["../../../../../../node_modules/engine.io-client/build/esm/transports/webtransport.js"],"sourcesContent":["import { Transport } from \"../transport.js\";\nimport { nextTick } from \"./websocket-constructor.js\";\nimport { createPacketDecoderStream, createPacketEncoderStream, } from \"engine.io-parser\";\nexport class WT extends Transport {\n    get name() {\n        return \"webtransport\";\n    }\n    doOpen() {\n        // @ts-ignore\n        if (typeof WebTransport !== \"function\") {\n            return;\n        }\n        // @ts-ignore\n        this.transport = new WebTransport(this.createUri(\"https\"), this.opts.transportOptions[this.name]);\n        this.transport.closed\n            .then(() => {\n            this.onClose();\n        })\n            .catch((err) => {\n            this.onError(\"webtransport error\", err);\n        });\n        // note: we could have used async/await, but that would require some additional polyfills\n        this.transport.ready.then(() => {\n            this.transport.createBidirectionalStream().then((stream) => {\n                const decoderStream = createPacketDecoderStream(Number.MAX_SAFE_INTEGER, this.socket.binaryType);\n                const reader = stream.readable.pipeThrough(decoderStream).getReader();\n                const encoderStream = createPacketEncoderStream();\n                encoderStream.readable.pipeTo(stream.writable);\n                this.writer = encoderStream.writable.getWriter();\n                const read = () => {\n                    reader\n                        .read()\n                        .then(({ done, value }) => {\n                        if (done) {\n                            return;\n                        }\n                        this.onPacket(value);\n                        read();\n                    })\n                        .catch((err) => {\n                    });\n                };\n                read();\n                const packet = { type: \"open\" };\n                if (this.query.sid) {\n                    packet.data = `{\"sid\":\"${this.query.sid}\"}`;\n                }\n                this.writer.write(packet).then(() => this.onOpen());\n            });\n        });\n    }\n    write(packets) {\n        this.writable = false;\n        for (let i = 0; i < packets.length; i++) {\n            const packet = packets[i];\n            const lastPacket = i === packets.length - 1;\n            this.writer.write(packet).then(() => {\n                if (lastPacket) {\n                    nextTick(() => {\n                        this.writable = true;\n                        this.emitReserved(\"drain\");\n                    }, this.setTimeoutFn);\n                }\n            });\n        }\n    }\n    doClose() {\n        var _a;\n        (_a = this.transport) === null || _a === void 0 ? void 0 : _a.close();\n    }\n}\n"],"names":["WT","Transport","name","doOpen","WebTransport","this","transport","createUri","opts","transportOptions","closed","then","onClose","catch","err","onError","ready","createBidirectionalStream","stream","decoderStream","createPacketDecoderStream","Number","MAX_SAFE_INTEGER","socket","binaryType","reader","readable","pipeThrough","getReader","encoderStream","createPacketEncoderStream","pipeTo","writable","writer","getWriter","read","done","value","onPacket","packet","type","query","sid","data","write","onOpen","packets","i","length","lastPacket","nextTick","emitReserved","setTimeoutFn","doClose","_a","close"],"mappings":"kNAGO,MAAMA,UAAWC,EAAAA,UACpB,QAAIC,GACA,MAAO,cACX,CACAC,MAAAA,GAEgC,mBAAjBC,eAIXC,KAAKC,UAAY,IAAIF,aAAaC,KAAKE,UAAU,SAAUF,KAAKG,KAAKC,iBAAiBJ,KAAKH,OAC3FG,KAAKC,UAAUI,OACVC,MAAK,KACNN,KAAKO,SAAS,IAEbC,OAAOC,IACRT,KAAKU,QAAQ,qBAAsBD,EAAI,IAG3CT,KAAKC,UAAUU,MAAML,MAAK,KACtBN,KAAKC,UAAUW,4BAA4BN,MAAMO,IAC7C,MAAMC,EAAgBC,EAAAA,0BAA0BC,OAAOC,iBAAkBjB,KAAKkB,OAAOC,YAC/EC,EAASP,EAAOQ,SAASC,YAAYR,GAAeS,YACpDC,EAAgBC,EAAAA,4BACtBD,EAAcH,SAASK,OAAOb,EAAOc,UACrC3B,KAAK4B,OAASJ,EAAcG,SAASE,YACrC,MAAMC,EAAOA,KACTV,EACKU,OACAxB,MAAK,EAAGyB,OAAMC,YACXD,IAGJ/B,KAAKiC,SAASD,GACdF,IAAM,IAELtB,OAAOC,OACV,EAENqB,IACA,MAAMI,EAAS,CAAEC,KAAM,QACnBnC,KAAKoC,MAAMC,MACXH,EAAOI,KAAO,WAAWtC,KAAKoC,MAAMC,SAExCrC,KAAK4B,OAAOW,MAAML,GAAQ5B,MAAK,IAAMN,KAAKwC,UAAS,GACrD,IAEV,CACAD,KAAAA,CAAME,GACFzC,KAAK2B,UAAW,EAChB,IAAK,IAAIe,EAAI,EAAGA,EAAID,EAAQE,OAAQD,IAAK,CACrC,MAAMR,EAASO,EAAQC,GACjBE,EAAaF,IAAMD,EAAQE,OAAS,EAC1C3C,KAAK4B,OAAOW,MAAML,GAAQ5B,MAAK,KACvBsC,GACAC,EAAAA,UAAS,KACL7C,KAAK2B,UAAW,EAChB3B,KAAK8C,aAAa,QAAQ,GAC3B9C,KAAK+C,aACZ,GAER,CACJ,CACAC,OAAAA,GACI,IAAIC,EACsB,QAAzBA,EAAKjD,KAAKC,iBAA8B,IAAPgD,GAAyBA,EAAGC,OAClE"}