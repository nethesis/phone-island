{"version":3,"file":"IslandDrag.js","sources":["../../src/components/IslandDrag.tsx"],"sourcesContent":["// Copyright (C) 2025 Nethesis S.r.l.\n// SPDX-License-Identifier: AGPL-3.0-or-later\n\nimport React, { type ReactNode, FC, useState, useRef, MutableRefObject } from 'react'\nimport { RootState, Dispatch, store } from '../store'\nimport { useSelector, useDispatch } from 'react-redux'\nimport { motion, useDragControls } from 'framer-motion'\nimport { useLongPress, useLocalStorage, styleTransformValues } from '../utils'\nimport { xPosition, yPosition } from '../lib/island/island'\n\nexport const IslandDrag: FC<IslandDragProps> = ({ children, islandContainerRef }) => {\n  const { startPosition } = useSelector((state: RootState) => state.island)\n\n  // Initialize the moved property\n  const [moved, setMoved] = useState<boolean>(false)\n\n  // Initialize dispatch\n  const dispatch = useDispatch<Dispatch>()\n\n  // Initialize Island drag controls\n  const controls = useDragControls()\n\n  // Initialize Island storage\n  const [phoneIslandStorage, setPhoneIslandStorage] =\n    useLocalStorage<PhoneIslandStorageTypes | null>('phone-island', null)\n\n  // The Island reference\n  const islandRef = useRef<any>(null)\n\n  // Initialize position or get from storage\n  const [position, setPosition] = useState<PositionTypes | null>(\n    phoneIslandStorage && phoneIslandStorage.position ? phoneIslandStorage.position : null,\n  )\n\n  // Handles the drag started event\n  function handleStartDrag(event: React.PointerEvent<Element>) {\n    const target = event.target as HTMLElement\n    if (\n      target.closest('[data-stop-propagation=\"true\"]') ||\n      target.hasAttribute('data-stop-propagation')\n    ) {\n      return\n    }\n\n    controls.start(event)\n  }\n\n  // Handles log press event\n  const handleLongPress = () => {}\n\n  const handleIslandClick = (event?: React.MouseEvent<Element> | any) => {\n    if (event && event.target) {\n      const target = event.target as HTMLElement\n      if (\n        target.closest('[data-stop-propagation=\"true\"]') ||\n        target.hasAttribute('data-stop-propagation')\n      ) {\n        return\n      }\n    }\n\n    // Only if phone island is close is possible to open it trough the click\n    const isPhoneIslandAlreadyOpen = store?.getState()?.island?.isOpen\n    !isPhoneIslandAlreadyOpen && dispatch.island.handleToggleIsOpen()\n  }\n\n  // Handles drag end event\n  const handleDragEnd = () => {\n    // Get initial transform values\n    let { x, y }: any = styleTransformValues(islandRef.current)\n    // Round position\n    x = xPosition(Math.round(x), islandRef.current, islandContainerRef.current)\n    y = yPosition(Math.round(y), islandRef.current, islandContainerRef.current)\n    // Save the new position to localstorage\n    setPhoneIslandStorage({\n      position: {\n        x,\n        y,\n      },\n    })\n    // Set position to variable\n    setPosition({\n      x,\n      y,\n    })\n  }\n\n  // Handles drag started event\n  function handleDragStarted() {\n    setMoved(true)\n  }\n\n  // Initialize the longPressEvent object\n  const longPressEvent = useLongPress(\n    handleLongPress,\n    handleIslandClick,\n    moved,\n    () => setMoved(false),\n    {\n      shouldPreventDefault: true,\n      delay: 250,\n    },\n  )\n\n  return (\n    <motion.div\n      drag\n      onPointerDown={handleStartDrag}\n      onDragStart={handleDragStarted}\n      dragTransition={{ \n        power: 0,\n        timeConstant: 300\n      }}\n      initial={{\n        x: position?.x || startPosition.x,\n        y: position?.y || startPosition.y,\n      }}\n      dragControls={controls}\n      dragListener={false}\n      dragConstraints={islandContainerRef}\n      onDragEnd={handleDragEnd}\n      ref={islandRef}\n      {...longPressEvent}\n      className='pi-absolute'\n    >\n      {children && children}\n    </motion.div>\n  )\n}\n\nexport default IslandDrag\n\nexport interface IslandDragProps {\n  children: ReactNode\n  islandContainerRef: MutableRefObject<HTMLDivElement>\n}\n\ninterface PhoneIslandStorageTypes {\n  position: PositionTypes\n}\n\ninterface PositionTypes {\n  x: number\n  y: number\n}\n"],"names":["IslandDrag","_a","children","islandContainerRef","startPosition","useSelector","state","island","_b","useState","moved","setMoved","dispatch","useDispatch","controls","useDragControls","_c","useLocalStorage","phoneIslandStorage","setPhoneIslandStorage","islandRef","useRef","_d","position","setPosition","longPressEvent","useLongPress","event","target","closest","hasAttribute","store","getState","isOpen","handleToggleIsOpen","shouldPreventDefault","delay","React","createElement","motion","div","drag","onPointerDown","start","onDragStart","dragTransition","power","timeConstant","initial","x","y","dragControls","dragListener","dragConstraints","onDragEnd","styleTransformValues","current","xPosition","Math","round","yPosition","ref","className"],"mappings":"ozBAUaA,EAAkC,SAACC,OAAEC,EAAQD,EAAAC,SAAEC,EAAkBF,EAAAE,mBACpEC,EAAkBC,eAAY,SAACC,GAAqB,OAAAA,EAAMC,wBAG5DC,EAAoBC,EAAAA,UAAkB,GAArCC,EAAKF,EAAA,GAAEG,EAAQH,EAAA,GAGhBI,EAAWC,EAAAA,cAGXC,EAAWC,EAAAA,kBAGXC,EACJC,EAAAA,gBAAgD,eAAgB,MAD3DC,EAAkBF,EAAA,GAAEG,OAIrBC,EAAYC,SAAY,MAGxBC,EAA0Bb,EAAAA,SAC9BS,GAAsBA,EAAmBK,SAAWL,EAAmBK,SAAW,MAD7EA,EAAQD,EAAA,GAAEE,EAAWF,EAAA,GA+D5B,IAAMG,EAAiBC,EAAAA,cA7CC,eAEE,SAACC,WACzB,GAAIA,GAASA,EAAMC,OAAQ,CACzB,IAAMA,EAASD,EAAMC,OACrB,GACEA,EAAOC,QAAQ,mCACfD,EAAOE,aAAa,yBAEpB,MAEH,GAGyD,QAAzBtB,EAAiB,QAAjBP,SAAA8B,EAAAA,YAAK,IAALA,EAAKA,WAAA,EAALA,EAAAA,MAAOC,kBAAU,IAAA/B,OAAA,EAAAA,EAAEM,cAAM,IAAAC,OAAA,EAAAA,EAAEyB,SAC/BrB,EAASL,OAAO2B,oBAC/C,GAgCExB,GACA,WAAM,OAAAC,GAAS,KACf,CACEwB,sBAAsB,EACtBC,MAAO,MAIX,OACEC,EAAC,QAAAC,cAAAC,SAAOC,gBACNC,MAAI,EACJC,cAxEJ,SAAyBf,GACvB,IAAMC,EAASD,EAAMC,OAEnBA,EAAOC,QAAQ,mCACfD,EAAOE,aAAa,0BAKtBhB,EAAS6B,MAAMhB,EAChB,EA+DGiB,YApBJ,WACEjC,GAAS,EACV,EAmBGkC,eAAgB,CACdC,MAAO,EACPC,aAAc,KAEhBC,QAAS,CACPC,GAAG1B,aAAQ,EAARA,EAAU0B,IAAK7C,EAAc6C,EAChCC,GAAG3B,aAAQ,EAARA,EAAU2B,IAAK9C,EAAc8C,GAElCC,aAAcrC,EACdsC,cAAc,EACdC,gBAAiBlD,EACjBmD,UArDkB,WAEhB,IAAArD,EAAgBsD,EAAAA,qBAAqBnC,EAAUoC,SAA7CP,EAAChD,EAAAgD,EAAEC,MAETD,EAAIQ,EAAAA,UAAUC,KAAKC,MAAMV,GAAI7B,EAAUoC,QAASrD,EAAmBqD,SACnEN,EAAIU,EAAAA,UAAUF,KAAKC,MAAMT,GAAI9B,EAAUoC,QAASrD,EAAmBqD,SAEnErC,EAAsB,CACpBI,SAAU,CACR0B,EAACA,EACDC,EAACA,KAIL1B,EAAY,CACVyB,EAACA,EACDC,EAACA,GAEL,EAoCIW,IAAKzC,GACDK,GACJqC,UAAU,gBAET5D,GAAYA,EAGnB"}