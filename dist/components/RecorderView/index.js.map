{"version":3,"file":"index.js","sources":["../../../src/components/RecorderView/index.tsx"],"sourcesContent":["// Copyright (C) 2024 Nethesis S.r.l.\n// SPDX-License-Identifier: AGPL-3.0-or-later\n\nimport React, { type FC, useState, useRef, useEffect, useCallback, memo } from 'react'\nimport { useDispatch, useSelector, shallowEqual } from 'react-redux'\nimport { Dispatch, RootState } from '../../store'\nimport { Actions } from './Actions'\nimport { BarsGroup } from './BarsGroup'\nimport Progress from '../AudioPlayerView/Progress'\nimport { updateAudioPlayerSource } from '../../lib/phone/audio'\nimport fixWebmDuration from 'webm-duration-fix'\nimport Timer from './Timer'\nimport { useTranslation } from 'react-i18next'\nimport { Button } from '../Button'\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome'\nimport { faTrash, faXmark, faPlay } from '@fortawesome/free-solid-svg-icons'\nimport { eventDispatch } from '../../utils'\n\n// The number of groups to be created\n// ...the minimun to have this effect is 2\nconst BAR_GROUPS_COUNT = 2\n\n// The mime type of the recorded audio\nconst MIME_TYPE = 'audio/webm'\n\nexport const RecorderView: FC<RecorderViewProps> = () => {\n  const { isOpen } = useSelector((state: RootState) => state.island)\n  const { audioPlayerPlaying } = useSelector((state: RootState) => state.player)\n  const visibleContainerRef = useRef<HTMLDivElement>(null)\n  const recorderRef = useRef<MediaRecorder | null>(null)\n  const mediaChunks = useRef<BlobPart[]>([])\n\n  // Initialize state dispatch\n  const dispatch = useDispatch<Dispatch>()\n\n  // Retrieve the local audio stream from webrtc state\n  const localAudioStream = useSelector((state: RootState) => state.webrtc.localAudioStream)\n\n  // Retrieve the local audio stream from recorder state\n  const { recording, recorded, waiting } = useSelector(\n    (state: RootState) => ({\n      recording: state.recorder.recording,\n      recorded: state.recorder.recorded,\n      waiting: state.recorder.waiting,\n    }),\n    shallowEqual,\n  )\n\n  function handleRecordedMedia(event: BlobEvent) {\n    mediaChunks.current.push(event.data)\n  }\n\n  async function handleRecordingStopped() {\n    const blob = await fixWebmDuration(new Blob(mediaChunks.current, { type: MIME_TYPE }))\n    const audioURL = URL.createObjectURL(blob)\n    // The next function is async\n    updateAudioPlayerSource(audioURL)\n  }\n\n  // Handle and manage audio recording start\n  useEffect(() => {\n    // @ts-ignore\n    if (localAudioStream?.active && recording) {\n      recorderRef.current = new MediaRecorder(localAudioStream, {\n        mimeType: MIME_TYPE,\n      })\n      recorderRef.current.ondataavailable = handleRecordedMedia\n      recorderRef.current.onstop = handleRecordingStopped\n      // Start the media recording\n      recorderRef.current.start()\n    }\n    // @ts-ignore\n  }, [localAudioStream?.active, recording])\n\n  // Handle and manage audio recorded\n  useEffect(() => {\n    if (recorded) {\n      mediaChunks.current = []\n      recorderRef.current?.stop()\n    }\n  }, [recorded])\n\n  // Handle view close and reset state\n  useEffect(() => {\n    // Set visible container reference to recorder state\n    dispatch.recorder.setVisibleContainerRef(visibleContainerRef)\n\n    return () => {\n      dispatch.recorder.reset()\n    }\n  }, [])\n\n  const { t } = useTranslation()\n\n  function playerClose() {\n    if (audioPlayerPlaying) {\n      dispatch.player.stopAudioPlayer()\n      eventDispatch('phone-island-audio-player-close', {})\n    }\n    dispatch.island.resetPlayerClose()\n  }\n\n  function close() {\n    dispatch.island.resetPlayerClose()\n  }\n\n  return (\n    <>\n      {isOpen ? (\n        <>\n          {' '}\n          <div className='pi-flex pi-items-center pi-justify-between pi-text-gray-900 dark:pi-text-gray-50'>\n            <h1 className='pi-text-lg pi-font-medium pi-leading-7'>{t('Common.Record message')}</h1>\n            <Button\n              onClick={() => close()}\n              variant='transparentSettings'\n              data-tooltip-id='tooltip-close-settings'\n              data-tooltip-content={t('Common.Close') || ''}\n            >\n              <FontAwesomeIcon icon={faXmark} className='pi-w-5 pi-h-5' />\n            </Button>\n          </div>\n          <div className='pi-pt-4'>\n            <div\n              className={`${\n                !recording || waiting || audioPlayerPlaying ? 'pi-mb-3' : ''\n              } pi-flex pi-w-full pi-justify-center pi-items-center`}\n            >\n              <div className='pi-font-medium pi-text-4xl pi-w-fit pi-h-fit dark:pi-text-white'>\n                <Timer />\n              </div>\n            </div>\n            {/* Bars animation section  */}\n            <div\n              className={`pi-relative pi-w-full pi-justify-center pi-overflow-hidden pi-flex pi-items-center`}\n              ref={visibleContainerRef}\n            >\n              {recorded ? (\n                <Progress />\n              ) : recording && !waiting ? (\n                <div className='pi-flex pi-items-center pi-justify-between pi-w-full pi-pb-3 pi-overflow-hidden'>\n                  {/* Play button (disabled) on left */}\n                  <Button variant='transparent' disabled className='pi-flex pi-flex-none'>\n                    <FontAwesomeIcon\n                      icon={faPlay}\n                      className='pi-h-4 pi-w-4 pi-text-gray-700 dark:pi-text-gray-200'\n                    />\n                  </Button>\n\n                  {/* Audio visualization in the middle */}\n                  <div className='pi-relative pi-overflow-hidden pi-flex pi-flex-grow pi-justify-center pi-h-4'>\n                    {/* Create a custom numbers of bars groups */}\n                    {Array.from({ length: BAR_GROUPS_COUNT }).map((_, i) => (\n                      <BarsGroup\n                        key={i}\n                        index={i}\n                        startAnimation={recording}\n                        audioStream={localAudioStream}\n                      />\n                    ))}\n                  </div>\n\n                  {/* Trash button (disabled) on right */}\n                  <Button variant='transparent' disabled className='pi-flex pi-flex-none'>\n                    <FontAwesomeIcon\n                      icon={faTrash}\n                      className='pi-h-4 pi-w-4 pi-text-gray-700 dark:pi-text-gray-200'\n                    />\n                  </Button>\n                </div>\n              ) : recording && waiting ? (\n                <div className='pi-sans pi-text-sm pi-w-fit pi-h-fit dark:pi-text-white pi-pb-7'>\n                  {t('Common.Start recording message after')}\n                </div>\n              ) : (\n                <div className='pi-sans pi-text-sm pi-w-fit pi-h-fit dark:pi-text-white pi-pb-7'>\n                  {t('Common.Start recording message before')}\n                </div>\n              )}\n            </div>\n          </div>\n          {/* Actions section */}\n          <Actions />\n        </>\n      ) : (\n        <div className='pi-font-medium pi-text-base'>Recorder</div>\n      )}\n    </>\n  )\n}\n\nexport interface RecorderViewProps {}\n"],"names":["MIME_TYPE","isOpen","useSelector","state","island","audioPlayerPlaying","player","visibleContainerRef","useRef","recorderRef","mediaChunks","dispatch","useDispatch","localAudioStream","webrtc","_a","recording","recorder","recorded","waiting","shallowEqual","handleRecordedMedia","event","current","push","data","handleRecordingStopped","fixWebmDuration","Blob","type","blob","sent","audioURL","URL","createObjectURL","updateAudioPlayerSource","useEffect","active","MediaRecorder","mimeType","ondataavailable","onstop","start","stop","setVisibleContainerRef","reset","t","useTranslation","React","createElement","Fragment","className","Button","onClick","resetPlayerClose","variant","FontAwesomeIcon","icon","faXmark","concat","Timer","ref","Progress","disabled","faPlay","Array","from","length","map","_","i","BarsGroup","key","index","startAnimation","audioStream","faTrash","Actions"],"mappings":"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"}