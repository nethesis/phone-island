"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../node_modules/tslib/tslib.es6.js"),n=require("react");require("../node_modules/react-redux/es/index.js");var t=require("../node_modules/socket.io-client/build/esm/index.js"),r=require("../lib/phone/conversation.js"),o=require("../services/user.js"),i=require("../utils/genericFunctions/eventDispatch.js"),c=require("../utils/genericFunctions/withTimeout.js"),s=require("../store/index.js");require("../lib/webrtc/janus.js"),require("../node_modules/webrtc-adapter/src/js/adapter_core.js");var a=require("../lib/devices/devices.js"),u=require("../lib/user/default_device.js"),l=require("../utils/genericFunctions/isEmpty.js"),d=require("../utils/streaming/getStreamingSourceId.js"),p=require("../events/SocketEvents.js"),m=require("../utils/genericFunctions/timestamp.js"),g=require("../lib/user/extensions.js"),v=require("../utils/streaming/isFromStreaming.js"),f=require("../node_modules/react-redux/es/hooks/useSelector.js");require("../node_modules/react-redux/es/components/Context.js"),require("../node_modules/hoist-non-react-statics/dist/hoist-non-react-statics.cjs.js"),require("../node_modules/react-redux/node_modules/react-is/index.js");var h=require("../node_modules/react-redux/es/hooks/useDispatch.js"),S=require("../lib/phone/trunk.js");function y(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var b=y(n);exports.Socket=function(y){var k=y.hostName,C=y.username,_=y.authToken,w=y.reload,N=y.reloadedCallback,D=y.children,j=y.uaType,U=h.useDispatch(),T=n.useRef(),x=n.useRef(),q=n.useRef(!1);f.useSelector((function(e){return e.currentUser}));return n.useEffect((function(){var n=function(e){if(e.counterpartNum&&v.isFromStreaming(e.counterpartNum)){U.island.setIsFromStreaming(!0),U.currentCall.updateCurrentCall({streamingSourceNumber:e.counterpartNum});var n=d.getStreamingSourceId(e.counterpartNum);n&&o.subscribe({id:n}).catch((function(e){return console.error("Error subscribing to streaming source:",e)}))}},f=function(e,t){var c=s.store.getState().currentCall,a=c.transferring,l=c.transferSwitching,d=c.transferCalls,p=s.store.getState().island.view;if(Object.keys(t).length>0){if(e.status){var v=s.store.getState().users.extensions,f=s.store.getState().currentUser.default_device,h=s.store.getState().currentUser,y=h.endpoints,b=h.username,k=s.store.getState().currentCall;k.incoming,k.outgoing;var C=function(){if(!v||!b)return!1;var e=Object.values(v).filter((function(e){return(null==e?void 0:e.username)===b}));return null==e?void 0:e.some((function(e){var n=null==y?void 0:y.extension.find((function(n){return n.id===(null==e?void 0:e.exten)}));return"nethlink"===(null==n?void 0:n.type)&&"offline"!==(null==e?void 0:e.status)}))};switch(e.status){case"ringing":if(n(t),"mobile"===j&&C()||"desktop"===j&&("webrtc"===(null==f?void 0:f.type)||void 0===(null==f?void 0:f.type)&&!C()||!C()&&"physical"===(null==f?void 0:f.type))){q.current||(q.current=!0,o.getCurrentUserInfo().then((function(e){e&&(U.currentUser.updateCurrentUser(e),e.settings&&e.settings.open_param_url?U.paramUrl.setOpenParamUrlType(e.settings.open_param_url):U.paramUrl.setOpenParamUrlType("never"))})).catch((function(e){console.error("Error getting current user info:",e)})).finally((function(){setTimeout((function(){q.current=!1}),100)}))),U.currentCall.checkIncomingUpdatePlay({conversationId:t.id,displayName:r.getDisplayName(t),number:"".concat(t.counterpartNum),incomingSocket:!0,incoming:!0,username:"".concat(v&&v[t.counterpartNum]&&v[t.counterpartNum].username)||"",ownerExtension:t.owner}),t.id,r.getDisplayName(t),"".concat(t.counterpartNum),t.owner,"".concat(v&&v[t.counterpartNum]&&v[t.counterpartNum].username),null==t||t.chDest,null==t||t.chSource,t.direction,t.inConference,t.linkedId,t.uniqueId,t.throughQueue,t.throughTrunk,t.recording,s.store.dispatch.island.setIslandView("call"),i.eventDispatch("phone-island-call-ringing",{});var _=s.store.getState().paramUrl.openParamUrlType,w=s.store.getState().island.urlOpened;if("ringing"===_&&!w){var N=S.isFromTrunk(t.counterpartNum);s.store.dispatch.paramUrl.setThroughTrunk(N),s.store.dispatch.island.setUrlOpened(!1),i.eventDispatch("phone-island-url-parameter-opened",{counterpartNum:t.counterpartNum,counterpartName:r.getDisplayName(t),owner:t.owner,uniqueId:t.uniqueId,throughQueue:t.throughQueue,throughTrunk:N,direction:t.direction,connected:t.connected})}}break;case"busy":if(n(t),"mobile"===j&&C()||"desktop"===j&&("webrtc"===(null==f?void 0:f.type)||void 0===(null==f?void 0:f.type)&&!C()||!C()&&"physical"===(null==f?void 0:f.type))){if(t&&t.connected)U.currentCall.updateCurrentCall({conversationId:t.id,displayName:r.getDisplayName(t),number:"".concat(t.counterpartNum),ownerExtension:t.owner,username:"".concat(v&&v[t.counterpartNum]&&v[t.counterpartNum].username)||"",chDest:(null==t?void 0:t.chDest)||{},chSource:(null==t?void 0:t.chSource)||{}}),U.currentCall.checkAcceptedUpdate({acceptedSocket:!0}),U.currentCall.addTransferCalls({type:"transferred",displayName:r.getDisplayName(t),number:"".concat(t.counterpartNum),startTime:"".concat(m.getTimestampInSeconds())}),s.store.getState().island.isFromStreaming&&"out"===t.direction&&setTimeout((function(){U.island.setIslandView("streamingAnswer")}),200),u.isPhysical()&&function(e){U.currentCall.updateCurrentCall({conversationId:e.id,accepted:!0,incoming:"in"!==e.direction&&void 0}),i.eventDispatch("phone-island-call-answered",{}),s.store.dispatch.player.stopAudioPlayer(),s.store.dispatch.player.setAudioPlayerLoop(!1)}(t),"call"===p&&a&&U.currentCall.updateCurrentCall({transferring:!1});if(d.length>1)U.currentCall.deleteTransferCalls();else if(t&&!t.connected){if(a&&!l){var D=d.find((function(e){return e.number===t.counterpartNum}));!t.connected&&D&&(U.currentCall.updateCurrentCall({transferring:!1}),i.eventDispatch("phone-island-call-transfer-failed",{}),U.currentCall.updateTransferSwitching(!1))}"REC"===(null==t?void 0:t.counterpartName)&&U.physicalRecorder.setRecordingTempVariable(!0)}t&&!t.connected&&"out"===t.direction&&U.currentCall.checkOutgoingUpdate({outgoingSocket:!0,outgoing:"REC"!==(null==t?void 0:t.counterpartName),displayName:r.getDisplayName(t),number:"".concat(null==t?void 0:t.counterpartNum),username:"".concat(v&&v[null==t?void 0:t.counterpartNum]&&v[null==t?void 0:t.counterpartNum].username)||""})}break;case"onhold":var T=t.counterpartName,x=t.counterpartNum,I=t.startTime;a&&x&&T&&"<unknown>"!==T&&(U.currentCall.addTransferCalls({type:"destination",displayName:r.getDisplayName(t),number:x,startTime:"".concat(m.getTimestampInSeconds())}),U.currentCall.updateCurrentCall({displayName:r.getDisplayName(t),number:x,startTime:"".concat(I/1e3),conversationId:t.id}),U.island.setIslandView("call"));break;case"busy_ringing":i.eventDispatch("phone-island-call-ringing",{})}}}else"online"==e.status&&g.userTotallyFree()&&(U.player.stopAudioPlayer(),U.currentCall.reset(),U.physicalRecorder.setRecordingTempVariable(!1),U.island.setIsFromStreaming(!1))};return x.current=t.io("https://"+k,{upgrade:!1,transports:["websocket"],reconnection:!0,reconnectionDelay:2e3}),U.websocket.update({socket:x.current}),x.current.on("connect",(function(){console.debug("Socket connected sid: ".concat(x.current.id)),i.eventDispatch("phone-island-socket-connected",{})})),x.current.on("disconnect",(function(e){console.debug("Socket disconnect - reason: ".concat(e)),e.includes("server disconnect")?i.eventDispatch("phone-island-server-disconnected",{}):i.eventDispatch("phone-island-socket-disconnected",{})})),x.current.io.on("error",(function(e){console.debug("Socket error: ",e)})),x.current.on("connect_error",(function(e){console.debug("Socket connect_error: ",e)})),x.current.io.on("reconnect",(function(e){i.eventDispatch("phone-island-socket-reconnected",{}),console.debug("Socket reconnect attemp ".concat(e," (sid: ").concat(x.current.id,")"))})),x.current.io.on("reconnect_attempt",(function(e){console.debug("Socket reconnect_attempt ".concat(e))})),x.current.io.on("reconnect_error",(function(e){console.debug("Socket reconnect_error: ",e)})),x.current.io.on("reconnect_failed",(function(){console.debug("Socket reconnect_failed")})),T.current=setInterval((function(){x.current.volatile.emit("ping",c.withTimeout((function(){U.alerts.removeAlert("socket_down"),i.eventDispatch("phone-island-alert-removed",{type:"socket_down"}),i.eventDispatch("phone-island-socket-disconnected-popup-close",{})}),(function(){U.alerts.setAlert("socket_down"),i.eventDispatch("phone-island-socket-disconnected-popup-open",{}),console.error("Socket is unreachable!")}),7e3))}),7e3),x.current.on("connect",(function(){console.debug("Socket on: "+k+" is connected!"),x.current.emit("login",{accessKeyId:"".concat(C),token:_,uaType:j})})),x.current.on("authe_ok",(function(){console.debug("Socket authentication success!"),i.eventDispatch("phone-island-socket-authorized",{})})),x.current.on("userMainPresenceUpdate",(function(n){s.store.dispatch.users.updateEndpointMainPresence(e.__assign({},n.mainPresence)),p.dispatchMainPresence(n)})),x.current.on("extenHangup",(function(e){var n=s.store.getState().currentUser,t=n.endpoints,r=n.username,o=s.store.getState().conference,c=o.isActive,a=o.conferenceStartedFrom,u=s.store.getState().island.view,l=((null==t?void 0:t.extension)||[]).find((function(n){return n.id===e.callerNum})),d=null==l?void 0:l.type;"normal_clearing"===e.cause&&("physical"===d||"mobile"===d)||"user_busy"===(null==e?void 0:e.cause)||"not_defined"===(null==e?void 0:e.cause)||"call_rejected"===(null==e?void 0:e.cause)?(setTimeout((function(){s.store.dispatch.island.toggleAvoidToShow(!1)}),500),c&&a!==r&&s.store.dispatch.conference.resetConference()):"normal_circuit_congestion"===(null==e?void 0:e.cause)&&c&&a===r?i.eventDispatch("phone-island-view-changed",{viewType:"waitingConference"}):"normal_clearing"!==e.cause&&"user_busy"!==(null==e?void 0:e.cause)&&"not_defined"!==(null==e?void 0:e.cause)&&"call_rejected"!==(null==e?void 0:e.cause)||"webrtc"!==d&&"nethlink"!==d||!c||a===r||s.store.dispatch.conference.resetConference(),"interworking"===(null==e?void 0:e.cause)&&c&&a===r&&"waitingConference"!==u&&i.eventDispatch("phone-island-view-changed",{viewType:"waitingConference"})})),x.current.on("extenConnected",(function(e){var n=s.store.getState().currentUser,t=n.default_device,r=n.endpoints,o=((null==r?void 0:r.extension)||[]).find((function(n){return n.id===e.extenConnected})),c=null==o?void 0:o.type;(("webrtc"===(null==t?void 0:t.type)||"nethlink"===(null==t?void 0:t.type))&&c&&("mobile"===c||"physical"===c)||"physical"===(null==t?void 0:t.type)&&c&&"physical"!==c)&&(s.store.dispatch.island.toggleAvoidToShow(!0),i.eventDispatch("phone-island-call-answered",{extensionType:c}))})),x.current.on("extenUpdate",(function(e){U.users.updateExtension(e);var n=s.store.getState().users.extensions,t={};for(var r in n){var o=n[r].username,i=n[r].exten;t[o]||(t[o]=[]),t[o].push(i)}var c=t[e.username],a=e.conversations[Object.keys(e.conversations)[0]]||{};if(p.dispatchExtensions(e),l.isEmpty(a)){var u=null==c?void 0:c.some((function(e){var t,r=null===(t=n[e])||void 0===t?void 0:t.conversations;return!l.isEmpty(r)}));u||p.dispatchConversations(e)}else p.dispatchConversations(e);e.username===C&&(f(e,a),U.currentUser.updateConversations(e))})),x.current.on("queueUpdate",(function(e){p.dispatchQueueUpdate(e)})),x.current.on("queueMemberUpdate",(function(e){p.dispatchQueueMemberUpdate(e)})),x.current.on("takeOver",(function(){p.dispatchAlreadyLogin()})),x.current.on("serverReloaded",(function(){p.dispatchServerReload()})),x.current.on("parkingUpdate",(function(){p.dispatchParkingUpdate()})),x.current.on("actionNethLink",(function(e,n){p.dispatchUrlCall(e,n)})),x.current.on("message",(function(e){switch(e.message){case"screenSharingStart":U.island.toggleSideViewVisible(!1),U.island.setIslandView("video"),U.screenShare.update({isJoiningScreenShare:!0,room:e.roomId});break;case"screenSharingStop":U.island.toggleSideViewVisible(!1),U.island.setIslandView("video"),U.screenShare.update({isLeavingScreenShare:!0});break;default:console.warn("Socket: unknown message type ",e.message)}})),x.current.on("updateDefaultDevice",(function(n){p.dispatchDefaultDeviceUpdate(n);var t=s.store.getState().users.extensions,r=s.store.getState().currentUser.endpoints;if(t&&r){var o=Object.values(t).filter((function(e){return(null==e?void 0:e.exten)===n}));if(0!==o.length){var i=o[0],c=r.extension.find((function(e){return e.id===i.exten}));c&&(i=e.__assign(e.__assign({},i),{type:c.type})),s.store.dispatch.currentUser.updateCurrentDefaultDevice(i),a.checkMediaPermissions()}}})),x.current.on("confBridgeUpdate",(function(n){if(n&&(null==n?void 0:n.users)){var t=null==n?void 0:n.id,r=null==n?void 0:n.users,o=s.store.getState().conference.usersList,i=e.__assign({},r);o&&Object.keys(i).forEach((function(n){o[n]&&(i[n]=e.__assign(e.__assign({},i[n]),{muted:o[n].muted}))})),s.store.dispatch.conference.updateConferenceUsersList(i),s.store.dispatch.conference.updateConferenceId(t)}})),x.current.on("confBridgeEnd",(function(e){e&&(null==e?void 0:e.id)&&(s.store.dispatch.conference.resetConference(),i.eventDispatch("phone-island-conference-finished",{}))})),x.current.on("callWebrtc",(function(e){i.eventDispatch("phone-island-call-start",{number:e})})),x.current.on("newVoiceMessageCounter",(function(e){i.eventDispatch("phone-island-voicemail-received",{voicemailInfo:e})})),x.current.on("streamingSourceUpdate",(function(e){i.eventDispatch("phone-island-streaming-information-received",{res:e});var n=e.streaming||e.res&&e.res.streaming;if(n){var t=n.source,r=n.image;if(t&&r){s.store.getState().island.isFromStreaming;var o=s.store.getState().currentCall.streamingSourceNumber;d.getStreamingSourceId(o),U.streaming.updateSourceImage({source:t,image:r})}}})),function(){clearInterval(T.current),x.current.close()}}),[k,C,_,j,U]),n.useEffect((function(){w&&(console.info("websocket reconnection"),x.current.disconnect(),x.current.connect(),N())}),[w]),b.default.createElement(b.default.Fragment,null,D)};
//# sourceMappingURL=Socket.js.map
